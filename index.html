
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>スマホアプリの設計と開発</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="./codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id=""
                  title="スマホアプリの設計と開発"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="はじめに" duration="0">
        <h2 is-upgraded>本書の内容</h2>
<p>本書では、データモデル設計とNoSQLデータベースとFirestoreについて学んだのち、レストランにレビューを追加するアプリを例にFirebaseとFlutterを使ったスマホアプリ開発する一連の流れをハンズオンします。</p>
<h2 is-upgraded>本書のコンセプト</h2>
<p>最近はコロナの影響もあり、在宅勤務が推奨され、学校の授業がオンライン化され、買い物はeコマースの利用が増加し、食事の際は出前アプリを使った配達が流行っています。コロナ以前も社会へのオンライン化の必要性が謳われていましたが、コロナ渦ではあらゆる生活シーンでオンライン利用が半強制化されているため、スマホやパソコンの所有率やITリテラシーは向上せざるを得ず、ますます使いやすいオンラインサービスに対する需要が増しています。</p>
<p>また最近のシステム開発の動きを見ると、いままで使いづらいサービスの代名詞であった行政や金融のオンラインサービスをユーザ中心設計を採用し、使いやすくセキュリティ上も安全なサービスに作り替えようとする取組が進められています。またIT化が比較的遅れていた中小企業においてもDX（デジタルトランスフォーメーション）を促進しようとする動きがあります。</p>
<p>あらゆる業界・組織において、あらゆる生活シーンでそれぞれの要件にあった使いやすいオンラインサービスが安価に構築・提供されることが求められています。</p>
<p>一方これらの要望を担う人材育成の観点では、子供から大人までプログラミング教育がはやっており、文科省は小学校でのプログラミング授業を必須化しています。</p>
<p>ただし、システム開発や人材育成において下記のような課題があると感じています。</p>
<ul>
<li>アプリ開発の要件定義や設計フェーズにおいて画面設計に走りがちで、データ構造やロジックの設計がおろそかになり、プログラマーが開発をはじめらずプロジェクトが遅延するといった状況に陥りがちです。20年近くIT企業でアプリ開発を実施してきましたが、昔も今もこのようなプロジェクトをいくつか見ています。</li>
<li>この原因としては、システムデザインについての手法（ドメイン駆動設計やシステムアーキテクチャなど）やその説明が高尚で難しいという問題があります。そのため、本来必要なシステムデザインがスルーされ、スケジュールのプレッシャーもあり、とりあえず簡易な画面設計に走ることにつながるのではと感じています。</li>
<li>昨今のユーザ中心設計の誤った解釈から、システムの顧客接点である画面のデザインがフォーカスされ、発注側の要件定義担当者やデザイナーを含めたプロジェクトメンバーが、本来画面設計の元になるはずのデータモデリングについて理解が乏しいことに原因があるのではとも感じています。</li>
<li>例えば、業務で扱うデータが整理できておらず各業務ステップで担当者が手動で作業をしているため、残業が減らないのでシステム化で改善したい、といった要望がありました。ここではアーキテクト不在で要件定義が進められ、プロジェクトマネージャやデザイナが画面設計に走り、プロジェクトの半年後はじめからやりなおしになりました。システム化とは業務とデータの整理整頓でありデータモデリングがはじめから必要であることを意識しておくべきです。</li>
<li>エンジニア育成という観点からは、従来のプログラミングの学習コンテンツはプログラミング言語の文法を学ぶことが目標となっており、出来上がったプログラムが端末に&#34;Hello World&#34;と表示するといった面白みにかけ作りたいものからかけ離れた学習内容になっていることが多いです。そのため初心者の時点からやる気をなくしてしまいます。</li>
<li>最近の子供向けプログラミング授業用ソフトは使いやすい見た目がよく、マウス操作でプログラミングの論理的思考が学べるといったすぐれた面がある一方、汎用的なアプリケーションを開発するため使えないといった欠点も見受けられます。</li>
</ul>
<p>以上のことから、エンジニアだけでなく発注側顧客企業の担当者やプロジェクトマネージャもユースケースからデータモデルに落とす考え方やデータモデルから画面設計を行うための考え方、さらにはこれらのパターンを知っていることが望まれます。</p>
<p>そこで本書ではデータモデリングの具体的な方法と考え方についても詳しく説明するよう心がけました。またエンジニア育成という観点では、アイデアが浮かんだらすぐに完成品までもっていけるよう効率的で汎用的なツールを選び、それらのハンズオンを掲載しています。具体的な選定理由は以下の通りです。</p>
<ul>
<li>開発対象のアプリは昨今の利用シーンを考えスマホアプリを対象としました</li>
<li>サーバ構築には、スマホアプリに一般的に必要となるサーバ機能をボタン一つで提供するGoogle Cloud Firebaseを採用しました</li>
<li>認証のしくみには、スマホアプリに即組み込めて、様々なタイプの認証機能を提供し、外部のOIDCサーバとも連携できるFirebase Authを採用しました</li>
<li>データベースには、リアルタイムデータベースとスマホアプリから安全に直接アクセスできるSDKが提供されているFirestoreを採用しました。本来ならデータベース構築以外にもアプリをデータベースにつなげるためのAPI開発やセキュリティ対策も必要になりますが、Firestoreの採用によりこれらの工数が劇的に削減されます。</li>
<li>スマホアプリ開発には、一つのプログラミングコードでiPhoneアプリもAndroidアプリもWebアプリも構築できるクロスプラットフォームの一つであるFlutterを採用しました。本来ならiPhoneアプリ、Androidアプリ、Webアプリそれぞれについて、異なる開発環境、プログラミング言語、開発フレームワークを使った開発が必要ですが、これらを一つの環境で同一のプログラミング言語で一回コーディングすることで可能にしています。これにより開発工数が大幅に削減されます。</li>
</ul>
<p>様々な立場の人が本書を読みハンズオンを試してもらうことで「こんなに簡単に作れるんだ」とものづくりに興味をもってもらい、自分たちが実現したいシステムを自らが構築するマインドをもっていただく一助になればと思っています。また本書をとおしてIT技術の活用が民主化されることで、自らの会社や組織、業界においてより価値を産むアイデア考察に積極的になり、多くの時間をついやすようになっていただければと願っています。</p>
<p>※ 著者は2020年2月に第33回「21世紀交流サロン・葵丘」にてこれらの考え方を「テクノロジーの民主化」と題して話しました。<a href="http://21cmikawa.jp/activity/activity.php" target="_blank">http://21cmikawa.jp/activity/activity.php</a></p>
<h2 is-upgraded>本書で学ぶこと</h2>
<ul>
<li>ユースケースからのデータモデリング方法</li>
<li>データモデルからの画面設計方法</li>
<li>ユースケース、データモデル、画面設計のパターン</li>
<li>NoSQLデータベースとCloud Firestoreの概要</li>
<li>Firebase AuthとFirestore、Cloud Functionsの使い方</li>
<li>Flutterを使ったアプリの開発</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="データモデル設計" duration="0">
        <p>データモデルの設計はユースケースからデータモデル候補を抜き出すことからはじめます。これによってデータの大きな単位とそこに含まれるフィールドを整理できます。また、ここで抽出されたデータ単位ごとにテーブルを作り、具体的なデータサンプルを作っておくと次ステップのデータ間の関係を考察する際に役立ちます。</p>
<p>データ候補が抽出できたら、まとめたデータサンプルを参照しながらそれらの関係を整理します。本書ではドキュメント型データベースを採用するため、ドキュメントとコレクションの関係を整理します（ドキュメント型データベースについては、「NoSQLとFirestoreについて」を参考にしてください）。前ステップで行ったデータ候補の抽出は比較的簡単な作業ですが、ここで行うデータ間の関係整理は経験が必要な難しい作業です。前ページ「はじめに」で挙げた課題である画面設計に走りがちな理由もこの難しさにあるものと考えられます。次ページ「ユースケース、データモデルと画面設計のパターン」では、よくあるユースケースとデータモデルと画面設計のパターンをまとめていますので、興味がある方はそちらを参照ください。</p>
<p>コレクションとドキュメントの分離方針がきまったら、サンプルデータをJSONの形式にまとめます。JSONスキーマにそった正しいJSON形式にまとめることでドキュメント型データベースで扱えるサンプルデータが作成されます。JSONとはWebアプリケーションやREST APIで扱われるプログラムが処理しやすく人も見やすいデータ形式ですが、初めてJSONを扱う人は正しいJSON形式とは何かわからないと思います。そのため本書では本文中にJSONエディタというツールを組み込んでJSONデータを表示し、JSON形式でのサンプルデータの作り方をステップバイステップで解説します。</p>
<h2 is-upgraded>1. ユースケースからデータの候補を抽出する</h2>
<p>顧客がレストランに対して星の数とコメントでレビューを記入し公開するアプリを例にしたユースケース記述を以下にまとめます。アプリ名は「レストランレビューアプリ」とします。</p>
<ol type="1" start="1">
<li>顧客はアプリにログインできる。</li>
<li>レストランのリストが表示される。</li>
<li>レストランのリストから一つを選ぶとレストランの詳細が表示でき、店名、料理の種類、住所、星の数の平均のほか、そのレストランに対するレビューがリスト表示される。</li>
<li>レストラン詳細画面では、星の数とコメントからなるレビューの登録ができ、登録更新時にレストランの星の数の平均が更新される。</li>
<li>全レビューのリストが表示され、星の数で検索できる。</li>
<li>顧客自身が登録したレビューについては編集と削除ができる</li>
</ol>
<p>このユースケース記述から得られるデータ候補を「ドキュメント（フィールド1、フィールド2、‥）」と表現すると下記のように整理できます。</p>
<ul>
<li>レストラン（店名、料理の種類、住所、星の数の平均）</li>
<li>レビュー（レビューした顧客名、星の数、コメント）</li>
<li>顧客（メールアドレス、氏名、アイコン）</li>
</ul>
<p>ここで具体的なサンプルデータを表形式にまとめておくとイメージしやすくなり今後の設計もしやすくなり、開発メンバーへの説明もしやすく開発やテスト等にも生かせます。</p>
<h3 is-upgraded>表1. レストラン</h3>
<table>
<tr><td colspan="1" rowspan="1"><p>ID</p>
</td><td colspan="1" rowspan="1"><p>店名</p>
</td><td colspan="1" rowspan="1"><p>種類</p>
</td><td colspan="1" rowspan="1"><p>住所</p>
</td><td colspan="1" rowspan="1"><p>星数</p>
</td><td colspan="1" rowspan="1"><p>ロゴ</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>0</p>
</td><td colspan="1" rowspan="1"><p>ガスト東岡崎店</p>
</td><td colspan="1" rowspan="1"><p>洋食</p>
</td><td colspan="1" rowspan="1"><p>愛知県岡崎市大西１丁目１−１０</p>
</td><td colspan="1" rowspan="1"><p>0</p>
</td><td colspan="1" rowspan="1"><p>https://www.skylark.co.jp/site_resource/gusto/images/logo.svg</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>デニーズ東岡崎店</p>
</td><td colspan="1" rowspan="1"><p>洋食</p>
</td><td colspan="1" rowspan="1"><p>愛知県岡崎市美合町 字五反田２５－１</p>
</td><td colspan="1" rowspan="1"><p>0</p>
</td><td colspan="1" rowspan="1"><p>https://sozainavi.com/wp-content/uploads/2019/10/dennys.jpg</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>2</p>
</td><td colspan="1" rowspan="1"><p>大戸屋ごはん処岡崎店</p>
</td><td colspan="1" rowspan="1"><p>和食</p>
</td><td colspan="1" rowspan="1"><p>愛知県岡崎市井田西町１−１１</p>
</td><td colspan="1" rowspan="1"><p>0</p>
</td><td colspan="1" rowspan="1"><p>https://sozainavi.com/wp-content/uploads/2019/10/ootoya.jpg</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>3</p>
</td><td colspan="1" rowspan="1"><p>和食さと岡崎店</p>
</td><td colspan="1" rowspan="1"><p>和食</p>
</td><td colspan="1" rowspan="1"><p>愛知県岡崎市上里２丁目１−１</p>
</td><td colspan="1" rowspan="1"><p>0</p>
</td><td colspan="1" rowspan="1"><p>https://sato-res.com/assets/tile/sato.png</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>4</p>
</td><td colspan="1" rowspan="1"><p>カレーハウスCoCo壱番屋岡崎上地店</p>
</td><td colspan="1" rowspan="1"><p>カレー</p>
</td><td colspan="1" rowspan="1"><p>愛知県岡崎市上地３丁目５１−６</p>
</td><td colspan="1" rowspan="1"><p>0</p>
</td><td colspan="1" rowspan="1"><p>https://www.ichibanya.co.jp/assets/images/common/ogp.png</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>5</p>
</td><td colspan="1" rowspan="1"><p>スシロー岡崎上和田店</p>
</td><td colspan="1" rowspan="1"><p>寿司</p>
</td><td colspan="1" rowspan="1"><p>愛知県岡崎市天白町東池１５−１</p>
</td><td colspan="1" rowspan="1"><p>0</p>
</td><td colspan="1" rowspan="1"><p>https://www.akindo-sushiro.co.jp/shared/images/ogp.png</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>6</p>
</td><td colspan="1" rowspan="1"><p>くら寿司北岡崎店</p>
</td><td colspan="1" rowspan="1"><p>寿司</p>
</td><td colspan="1" rowspan="1"><p>愛知県岡崎市錦町２−１２</p>
</td><td colspan="1" rowspan="1"><p>0</p>
</td><td colspan="1" rowspan="1"><p>https://www.watch.impress.co.jp/img/ipw/docs/1230/499/kura1_s.jpg</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>7</p>
</td><td colspan="1" rowspan="1"><p>モスバーガー岡崎大西店</p>
</td><td colspan="1" rowspan="1"><p>ハンバーガ</p>
</td><td colspan="1" rowspan="1"><p>愛知県岡崎市大西１丁目１６−７</p>
</td><td colspan="1" rowspan="1"><p>0</p>
</td><td colspan="1" rowspan="1"><p>http://www.wing-net.ne.jp/image/kamiooka/store/storage/w250/mos.png</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>8</p>
</td><td colspan="1" rowspan="1"><p>マクドナルド岡崎インター店</p>
</td><td colspan="1" rowspan="1"><p>ハンバーガ</p>
</td><td colspan="1" rowspan="1"><p>愛知県岡崎市大平町石丸６０−１</p>
</td><td colspan="1" rowspan="1"><p>0</p>
</td><td colspan="1" rowspan="1"><p>https://sozainavi.com/wp-content/uploads/2019/10/mcdonalds.png</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>9</p>
</td><td colspan="1" rowspan="1"><p>かつや愛知岡崎インター店</p>
</td><td colspan="1" rowspan="1"><p>とんかつ</p>
</td><td colspan="1" rowspan="1"><p>愛知県岡崎市大平町新寺25</p>
</td><td colspan="1" rowspan="1"><p>0</p>
</td><td colspan="1" rowspan="1"><p>https://www.arclandservice.co.jp/katsuya/wp-content/themes/arclandservice-group/assets/img/katsuya/common/logo.svg</p>
</td></tr>
</table>
<h3 is-upgraded>表2. レビュー</h3>
<p>レストラン「ガスト東岡崎店」に対するレビュー</p>
<table>
<tr><td colspan="1" rowspan="1"><p>ID</p>
</td><td colspan="1" rowspan="1"><p>顧客名</p>
</td><td colspan="1" rowspan="1"><p>星数</p>
</td><td colspan="1" rowspan="1"><p>コメント</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>0</p>
</td><td colspan="1" rowspan="1"><p>鈴木一郎</p>
</td><td colspan="1" rowspan="1"><p>2</p>
</td><td colspan="1" rowspan="1"><p>値段の割に合わない気がする。</p>
<p>チーズハンバーグを頼んだが、レトルトな感じでした。</p>
<p>さらに、スープセットにしたが、スープは一種類。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>佐藤二郎</p>
</td><td colspan="1" rowspan="1"><p>3</p>
</td><td colspan="1" rowspan="1"><p>タブレットによる注文に変わったが、慣れが必要。</p>
<p>メニューを広げて、料理を比べたい。</p>
<p>この方式で価格が下がればよいが、，，</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>2</p>
</td><td colspan="1" rowspan="1"><p>北島三郎</p>
</td><td colspan="1" rowspan="1"><p>5</p>
</td><td colspan="1" rowspan="1"><p>ドリンクバーが99円(単品で注文してもOK)。</p>
<p>パソコンの持ち込みOK。</p>
<p>コンセントで充電できる。持ち帰り容器は無料。</p>
<p>食べきれない料理の持ち帰りOK。</p>
<p>トイレは新しくてキレイ</p>
</td></tr>
</table>
<h3 is-upgraded>表3. 顧客</h3>
<table>
<tr><td colspan="1" rowspan="1"><p>ID</p>
</td><td colspan="1" rowspan="1"><p>メールアドレス</p>
</td><td colspan="1" rowspan="1"><p>氏名</p>
</td><td colspan="1" rowspan="1"><p>アイコン</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>0</p>
</td><td colspan="1" rowspan="1"><p>ichiro@test.com</p>
</td><td colspan="1" rowspan="1"><p>鈴木一郎</p>
</td><td colspan="1" rowspan="1"><p>https://meikyu-kai.org/wp-content/uploads/2020/01/51_Ichiro.jpg</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>jiro@test.com</p>
</td><td colspan="1" rowspan="1"><p>佐藤二郎</p>
</td><td colspan="1" rowspan="1"><p>http://www.from1-pro.jp/images/t_10/img_l.jpg?1597426029</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>2</p>
</td><td colspan="1" rowspan="1"><p>saburo@test.com</p>
</td><td colspan="1" rowspan="1"><p>北島三郎</p>
</td><td colspan="1" rowspan="1"><p>https://cdn.asagei.com/asagei/uploads/2016/08/20160810kitajima.jpg</p>
</td></tr>
</table>
<h2 is-upgraded>2. データをドキュメントとコレクションのツリー構造にする</h2>
<p>1で抽出したデータをドキュメントとコレクションの関係についての方針を整理します。</p>
<ol type="1" start="1">
<li>レストランドキュメントと顧客ドキュメントはルートレベルコレクションに納める</li>
<li>レビュードキュメントはレストラン・ドキュメントのサブコレクションに納める</li>
<li>レビュードキュメントに顧客フィールドの一部をマップとして納める</li>
</ol>
<p>これらの関係を表現したツリー構造を下図に示します。</p>
<p class="image-container"><img style="width: 591.38px" src="img/392308f2014e0d18.png"></p>
<h2 is-upgraded>3. サンプルデータをJSON形式で表現する</h2>
<p>ドキュメントとコレクションの関係について方針が決まったら、1のサンプルデータをJSON形式であらわすことでより具体化します。</p>
<p>ここではJSONエディタを使い、段階的にサンプルのJSONデータを作成します。</p>
<aside class="warning"><p><strong>ノート: </strong>JSONエディタを使うと直感的にJSON形式のデータを作成、編集することができます。操作方法は下記の通りです。</p>
<p>1. 表示形式を下記の通り変更できます。</p>
<p>「Code」を選ぶとJSONの生データの形式で表示されます。</p>
<p class="image-container"><img style="width: 396.50px" src="img/889d519c5f591478.png"></p>
<p>「Tree」を選ぶとJSONデータを解釈したツリーが表示されます。</p>
<p class="image-container"><img style="width: 397.50px" src="img/b329e5204edbb65f.png"></p>
<p>「Tree」表示でヘッダ部分の左から1つめのアイコン<img style="width: 20.00px" src="img/b9c283c10a282add.png">を選ぶと閉じていたツリー全体を開けます。その右のアイコンでツリー全体を閉じます。</p>
<p class="image-container"><img style="width: 402.29px" src="img/4a990977802676bd.png"></p>
<p>2. 編集する際は「Code」表示にして行います。JSON形式にエラーがあるとエディタの左部分に「✖️」が表示されるので指示に従って修正します。</p>
</aside>
<h4 is-upgraded><strong>3-1. レストラン・ドキュメントの作成</strong></h4>
<p>上記表1のIDが0のレコードを参考にレストラン・ドキュメントを作成します。</p>
<iframe width="820" height="220" src="./json01.html" frameborder="1"></iframe>
<p>JSONではデータのひとつの塊であるドキュメントを { } で囲み、その中に &#34;属性名&#34;: &#34;属性値&#34; をカンマ（ , ）で区切ってリストします。</p>
<h4 is-upgraded><strong>3-2. レストラン・コレクションの作成</strong></h4>
<p>上記表1の通りレストランは10個存在するため、配列をあらわすコレクションとして表現します。</p>
<iframe width="820" height="420" src="./json02.html" frameborder="1"></iframe>
<p>JSONではこのコレクションを { &#34;配列名&#34;: [(ドキュメントをカンマ( , )で区切ってリスト)] } で表現します。</p>
<h4 is-upgraded><strong>3-3. 顧客コレクションの追加</strong></h4>
<p>レストランと同じく顧客コレクションもルートレベルに追加します。</p>
<iframe width="820" height="420" src="./json03.html" frameborder="1"></iframe>
<p> JSONでは二つのコレクションを { &#34;users&#34;: [(...)], &#34;restaurants&#34;: [(...)] } と表現します。 </p>
<h4 is-upgraded><strong>3-4. レビュー・ドキュメントをレストラン・ドキュメント配下のサブコレクションとして追加</strong></h4>
<p>レビュー・ドキュメントの配列であるコレクションをレストラン・ドキュメント配下に追加します。この時、レビュー・ドキュメントには書き込みを行った顧客がわかるように顧客IDと顧客名と顧客写真を追加します。また、レビュー・ドキュメントを参照するだけで書き込みを行ったレビュー対象のレストランがわかるよう、レストランID、レストラン名、レストランロゴといった項目も追加します。以上の作業の必要性については「NoSQLとFirestoreについて」を参照してください。</p>
<iframe width="820" height="820" src="./json04.html" frameborder="1"></iframe>


      </google-codelab-step>
    
      <google-codelab-step label="画面設計" duration="0">
        <p>データモデルができあがったので次のステップとして画面設計を行います。</p>
<h2 is-upgraded>1. 画面設計の基本的な考え方</h2>
<p>画面設計では、「画面」と「画面遷移」をデザインします。</p>
<p class="image-container"><img style="width: 422.00px" src="img/eb6196052fed342d.png"></p>
<p>「画面」はユーザが一時点で対面する一画面のことで、テキストフィールドやボタンなどのコンポーネントを組み合わせて作成されます。一方、「画面遷移」は複数の「画面」が違いに移動していく振る舞いのことを表します。「画面」はユースケースごとに様々な特徴がありますので、次章でいくつか紹介しますが、「画面遷移」はパターン化が可能ですので、ここでは以下の４パターンにまとめます。</p>
<h3 is-upgraded><strong>① メニュー遷移</strong></h3>
<p>アプリケーションは複数の機能から成り立つので、ホーム画面にメニューやナビゲーションバーを用意して、そこからユーザがメニューを選択することで機能を切り替えます。下図は時計アプリを例に挙げて「時計」表示と「アラーム」設定、時計「設定」の3機能をボトムナビゲーションバーを使って切り替える画面遷移を表しています。</p>
<p class="image-container"><img style="width: 533.00px" src="img/d5476a8c62ab283.png"></p>
<p>このパターンの画面遷移では機能が切り替わるため、機能間でデータの引き継ぎが必要なケースは少なく、機能内でのデータ保存のみを考えればよいです。</p>
<h3 is-upgraded><strong>② ウィザード遷移</strong></h3>
<p>スマートフォンは画面が小さいため、多くの入力を必要とするアンケートや申請書は下図のとおり画面を複数にわけてウィザード形式で入力を促し、最後に確認してSubmitするといった画面遷移になります。</p>
<p class="image-container"><img style="width: 421.00px" src="img/6f62b102d1eaad18.png"></p>
<p>このパターンは途中で枝分かれすることなく一本線でゴールに向かう場合に利用し、分岐が発生する複雑な場合は次の状態遷移を考えるとよいでしょう。</p>
<h3 is-upgraded><strong>③ 状態遷移</strong></h3>
<p>状態によって表示する画面が変化する画面遷移のパターンです。ログイン・ログアウトの画面遷移が代表的な例で、ログインとログアウトのどちらかをあらわす状態変数の値に従って、表示される画面を切り替えるしくみになっています。</p>
<p class="image-container"><img style="width: 333.00px" src="img/816de381550c54c5.png"></p>
<p>スマホアプリの開発では、この状態の保持という概念がとても重要です。ユーザがアプリを通して何かデータの入力や変更を行うときのデータだけでなく、ログインしているかログアウトしたか、どの画面に遷移したかなど、画面を動かすために機能する状態もあります。この状態遷移としてよく現れる画面遷移のパターンは次の「④リストのCRUD」です。</p>
<h3 is-upgraded><strong>④ リストのCRUD </strong></h3>
<p>ビジネスアプリケーションの多くは、複数データを表示・追加・編集・削除しながら整理整頓するものです。そのため、データの概要をリスト表示して、そのうち一つをクリックすると詳細を表示し、編集・削除する、といった機能を持ちます。このタイプのアプリケーションの画面遷移は大概下記のようなフローになります。各画面の説明カッコ内の「Create」「Read」「Update」「Delete」はあわせてCRUD（クラッド）と呼び、データ操作の基本になります。ここでは複数データを扱っていますので、「Read」にはリストの読み込み表示と一つのデータの詳細な読み込み表示の二種類があるので、画面が二つになっています。</p>
<p class="image-container"><img style="width: 507.00px" src="img/d38dd34cf41d7b63.png"></p>
<p>上図の時計アプリの例では、リスト表示をする対象がアラーム設定した時刻といったシンプルなデータでしたが、本書で開発する「レストランレビューアプリ」のようにレストランデータが複数あり、さらにそのレストランのレビューデータが複数あるといった構造を持つ場合、レストランの詳細画面の下にレビューリストを表示するといった構造を持ちます。このように、複数データを整理整頓する形式のアプリ画面はリスト画面を中心にCRUDを担う機能に画面が分かれることをパターンとして覚えておくとよいでしょう。</p>
<h2 is-upgraded>2. 「レストランレビューアプリ」の画面設計</h2>
<p>本書で開発する「レストランレビューアプリ」の画面設計を「①ログイン、メニュー選択、ログアウト」と「②レストランリストとレビュー表示」、「③全レビューリストとレビュー表示」、「④アカウント表示と自分が投稿したレビューの管理」の4種類にわけて説明します。</p>
<p>①ログイン、メニュー選択、ログアウト</p>
<p>ログイン・ログアウトとメニュー遷移の画面と画面遷移を下図に示します。「アカウント画面」からのみログアウトできるよう設計していますが、どこからでもログアウトできるように設計してもよいでしょう。またログイン画面はユーザ登録画面と同一画面上で切り替えられるように設計しています。</p>
<p class="image-container"><img style="width: 601.70px" src="img/aa8613f8d8da27f9.png"></p>
<p>本設計は「1. 画面設計の基本的な考え方」で述べた「③状態遷移」のログイン・ログアウトと「①メニュー遷移」のパターンを利用しています。</p>
<p>②レストランリストとレストラン詳細、レビュー表示とレビュー追加</p>
<p>レストランをリスト表示し、そこから一つを選択するとレストラン詳細が表示されるとともに選択したレストランに関するレビューがリストされます。さらに、そこからレビューを一つ選択するとレビューの詳細が表示されます。また、レストラン詳細画面からはレビューを追加することができますが、リストされるレビューは自分以外のものも含まれるので、編集や削除はできないよう設計しています。</p>
<p class="image-container"><img style="width: 601.70px" src="img/657713c9f4970561.png"></p>
<p>本設計は「1. 画面設計の基本的な考え方」で述べた「④リストのCRUD」のパターンを利用しています。</p>
<p>③全レビューリストとレビュー表示</p>
<p>レビュー画面では、全レストランを対象に全ユーザのレビューの一覧をリストします。また、星数で検索することが可能です。</p>
<p class="image-container"><img style="width: 601.70px" src="img/7b7e3bcc509176b7.png"></p>
<p>本設計も「1. 画面設計の基本的な考え方」で述べた「④リストのCRUD」のパターンを利用していますが、ここではレビューの一覧が目的で、参照（Read）のみで追加（Create）、更新（Update）、削除（Delete）の機能は有していません。</p>
<p>④アカウント表示と自分が投稿したレビューの管理</p>
<p>アカウント画面では、自分の名前を直接編集できるように設計しました。また自分が投稿したレビューをリストし、編集と削除が可能です。</p>
<p class="image-container"><img style="width: 601.70px" src="img/492584221832d155.png"></p>
<p>本設計も「1. 画面設計の基本的な考え方」で述べた「④リストのCRUD」のパターンを利用しており、自分が投稿したレビューを対象に更新（Update）と削除（Delete）ができるよう設計しています。</p>


      </google-codelab-step>
    
      <google-codelab-step label="ユースケース、データモデル、画面設計パターン" duration="0">
        <p>ここでは様々なユースケースの画面設計を紹介します。「1. 特徴的な機能の画面」では主に一つの画面に特徴的な機能を有しているもので、よく使う例を紹介します。2以降は、世にあるアプリのユースケースをいくつか例に挙げ、それらのデータモデルと画面設計のパターンを紹介します。これらを理解し参考にすることで、経験の少ない方でもみずからのユースケースから適切な設計を行うことが可能になるでしょう。</p>
<h2 is-upgraded>1. 特徴的な機能の画面</h2>
<p>上で紹介したとおり世の中の主要なアプリケーション、特にビジネス用途のアプリケーションはログインしたユーザの権限で複数データを整理整頓を行うことを目的としており、1で紹介した画面遷移パターンの組み合わせで事足ります。一方、下記に挙げる機能はよく使われると共に特殊な画面を持ちますので、パターンとして覚えておくとよいでしょう。</p>
<h3 is-upgraded><strong>① スケジュールとカレンダー</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② 地図</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ チャット・グループチャット</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>④ 決済・ポイント支払</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>⑤ イラスト・写真加工</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>⑥ OCR・物体認識</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>⑦ その他</strong></h3>
<p>ゲームやAR、スマートスピーカーといったアプリケーションは複雑なUIからなりたっていたり、音声によるUIからなりたつため一般化は難しく、本書の対象外とします。</p>
<h2 is-upgraded>2. メモアプリ</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>3. 学生名簿</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>4. 観光地紹介</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>5. 会議室予約</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>6. 商品購入</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>7. 出前</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>8. ホテル予約</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>9. 高速バス予約</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>10. 営業支援</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>11. 保険契約管理</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>12. 物品管理</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>13. ホームページ管理</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>14. 出張申請・精算</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>15. アンケート</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>16. 講義・授業管理</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>17. テスト・試験</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>18. Web会議</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>19. 恋人マッチング</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>
<h2 is-upgraded>20. 画像認識レジ</h2>
<p>TODO</p>
<h3 is-upgraded><strong>① ユースケース</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>② データモデル</strong></h3>
<p>TODO</p>
<h3 is-upgraded><strong>③ 画面設計</strong></h3>
<p>TODO</p>


      </google-codelab-step>
    
      <google-codelab-step label="マテリアルデザイン" duration="0">
        <p>ここでは画面設計に関連して、Googleが2014年に発表したUIデザインのガイドラインであるマテリアルデザインを紹介します。特にスマホアプリのUIデザインにフォーカスし、スマホアプリ特有の問題からデザインの歴史を説明してから、マテリアルデザインが出現してきた背景について紹介します。</p>
<h2 is-upgraded>1. スマートフォンの特徴</h2>
<p>スマートフォンには、パソコンとは異なる下記の特徴があります。</p>
<h4 is-upgraded><strong>画面が小さく操作手段が限定的</strong></h4>
<p>スマホは画面が小さくさらにマウスやキーボードがないため操作手段が限定されるため、画面レイアウトや操作方法をどのようにデザインするかでユーザ満足度が大きく変化します。</p>
<h4 is-upgraded><strong>画面サイズがばらばら</strong></h4>
<p>AndroidとiPhoneという違いだけでなく、同種のスマホでも画面サイズがさまざまで、アプリのレイアウト幅や高さを固定すると画面表示が崩れて使い物にならなくなります。例えば、歴代のiPhoneを比べても下図のとおり様々な画面サイズが存在しますし、Androidは各デバイス開発会社が様々なものを出しているのでiPhone以上に画面サイズはバラバラです。</p>
<p class="image-container"><img style="width: 577.00px" src="img/886625a7f19811a7.png"></p>
<h2 is-upgraded>2. スマホアプリで発生しやすい問題</h2>
<p>Google PlayやApp Storeに登録された実際のアプリの評判からまとめたスマホアプリに対するよくある悪評は主に以下の4つです。</p>
<ol type="1" start="1">
<li>操作途中でクラッシュしてしまう</li>
<li>元の画面に戻れない、探している機能に行き着かない、といったナビゲーション機能が不十分</li>
<li>デザインが必要以上に凝っていて意味不明</li>
<li>大量の情報がそのまま表示され、検索したりフィルタリングする機能がない</li>
</ol>
<p>これらの悪評のうち、2から4まではUIデザインの問題といえます。</p>
<h2 is-upgraded>3. スマホデザインの歴史</h2>
<p>それではスマホにおけるデザインはどのような歴史を歩んできたのでしょうか。</p>
<p>まず、2000年前半のWebやアプリケーションのUIはそれまでのWindowsパソコンが機械的で使いづらく利用者のことを考えて作られていないという反省から、現実世界を模した装飾的なデザインからなるUIを取り入れるようになりました。この考え方によるデザインをスキューモーフィズムと呼びます。ただし、この装飾に凝ったデザインでは、デザイナーの主張が先行し、見た目や操作性に統一感がないといった弊害を生むことになりました。</p>
<p>そのため、20世紀初頭のモダニズムが建築や工業製品のデザインに取り入れられたように、パソコンやWebやスマホのデザインにも極力装飾を廃したフラットデザインが採用されることになりました。ただし、フラットデザインはシンプルすぎて、システムの構造やしくみが理解しづらいといったデメリットが挙げられます。</p>
<table>
<tr><td colspan="1" rowspan="1"><p>iPhone6のスキューモーフィズム</p>
<p class="image-container"><img style="width: 259.50px" src="img/13bf84e545185e44.png"></p>
</td><td colspan="1" rowspan="1"><p>iPhone7のフラットデザイン</p>
<p class="image-container"><img style="width: 251.75px" src="img/bd026add4995ef9e.png"></p>
</td></tr>
</table>
<p>そこで、Googleはフラットデザインとスキューモフィズムの中間をとり、さらに発展させた「マテリアルデザイン」を定義し、2014年にだれもが参照して利用できるオープンソースな形でデザインガイドラインを発表しました。</p>
<h2 is-upgraded>4. マテリアルデザインとは？</h2>
<p>マテリアルデザインとは、Googleが2014年に発表したUIのデザインガイドラインです。Googleは、Gmailなどの数多くのアプリを世に出していましたが、それらがパソコン、Android、iPhone、タブレットなど異なるデバイスで利用されるとき、画面サイズもOSも異なるため、異なった見た目と操作性を持ってしまったことを問題視していました。そのため、デバイスが異なっていても、各自の特徴を踏まえながら統一したデザインで操作できるようなUIデザインのガイドラインを作ろうという目的で開発されたのがマテリアルデザインです。例えば、スマホのようなデバイス用には、手のひらで操作することを想定し、直感的で意味のある物理的（マテリアル）な概念をデザインに取り入れてガイドラインが策定されています。</p>
<p>マテリアルデザインは、あくまでもガイドラインであるため、必ず準拠すべきものではありませんが、デザインの部品がどのような形でどのように動くかが細かく規定されており、Java、Kotlin、Swift、JavaScript、Flutterといったさまざまな言語に対応した無料で利用できるプログラムとともに提供されているため、まるまる採用することで一定レベル以上のUIデザインを実現したアプリを少ないコストで開発することができます。そのため、多くのプロジェクトで広く採用されるに至っています。</p>
<h2 is-upgraded>5. マテリアルデザインの4つの考え方</h2>
<p>マテリアルデザインは以下の4つのコンセプトからなりたっています。</p>
<p>①形をもった面</p>
<p>形をもったうすい紙のような面が重なって画面を表示するしくみを採用しています。この考え方によって、一枚の紙を切って分割して記事を表示したり、メニューやフッターを表示するための紙と中心のコンテンツをのせるための紙が重なって表示されることを影を使って表現することができます。これによって実際は奥行きがなくフラットなスマホの画面を立体的に表現することによって、表示されているものの種類が区別しやすくなったり、高さを使うことで手前にあるものほど重要といったユーザが3次元の世界で感じるのと同じくどこに注意をむけるべきかを直感的に知らせることができるようになっています。</p>
<aside class="warning"><p><strong>ノート: </strong>指によるタッチや文字入力など人による操作は物理的なルールに従い画面表示に影響を及ぼします。また面は厚さを持つので同じ奥行きに存在することはなく透過することもないといった実際の物理的な世界の常識を反映します。このように、面・奥行き・光と影に関しては下記のルールにのっとって実装されています。</p>
<p>面：現実世界の物理世界をスマホ画面のデザインに反映し、画面に表示される部品は厚さ1dp(ドットポイント)の面で構成されます。</p>
<p><a href="https://material.io/design/environment/surfaces.html" target="_blank">https://material.io/design/environment/surfaces.html</a></p>
<p>奥行き：概念的には面が何層にも重なっていて奥行きをもった構造を持っています。</p>
<p><a href="https://material.io/design/environment/elevation.html" target="_blank">https://material.io/design/environment/elevation.html</a></p>
<p>光と影：面と面との奥行きの違いは後ろの面にうつった影によって表現され、手前の面が手前に浮き上がれば影は大きくなります。</p>
<p><a href="https://material.io/design/environment/light-shadows.html" target="_blank">https://material.io/design/environment/light-shadows.html</a></p>
</aside>
<p>②印刷物のようなデザイン</p>
<p>文字や絵が紙に載っているという概念からなり、ベースラインやキーラインといった印刷物のコンセプトを踏襲しています。ベースラインを決めることでコンテンツが収まる範囲を決めたり、本文やタイトルなどはキーラインを基準に配置するなど、印刷用にワードなどに設定する値などを応用することで、見た目に統一感を持たせて画面を美しくみせます。また見やすいフォントが無料で提供されています。</p>
<p>③意味のあるアニメーション</p>
<p>ユーザになんらかの意味を伝えるためにはアニメーションが効果的な場合がありますが、コンポーネントにアニメーション表示を簡単にほどこせるようなしくみを実装しています。</p>
<p>④アダプティブデザイン</p>
<p>パソコン、Androidスマホ、iPhone、タブレットなどデバイスが異なり画面サイズが異なっていても形を崩さず表示するしくみを実装しています。レスポンシブデザインも同じコンセプトですが、アダプティブデザインは横幅の伸び縮みだけでなく、メニューの表示非表示などより画面サイズに応じた（アダプティブな）形でデザインを変化させるしくみをそなえています。</p>
<h2 is-upgraded>6. Flutterにおけるマテリアルデザイン</h2>
<p>マテリアルデザインを使うと下記のようなリッチなUI画面を実装することができます。下の例はFlutterを使って実装したUI画面のサンプルギャラリーです。</p>
<iframe width="800" height="600" src="https://gallery.flutter.dev/" frameborder="1"></iframe>
<aside class="warning"><p><strong>ノート: </strong>Flutterチームは、改変可能で商用利用可能なオープンソースライセンスであるBSDライセンスで豊富なデモサンプルをソースコードと一緒に提供しています。</p>
<p><a href="https://flutter.github.io/samples/#?platform=web" target="_blank">https://flutter.github.io/samples/#?platform=web</a></p>
</aside>
<p>Flutterにおけるマテリアルデザインは下記のような部品を提供しています。詳細は<a href="https://material.io/components" target="_blank">こちら</a>を参照してください。</p>
<table>
<tr><td colspan="1" rowspan="1"><p><a href="https://material.io/develop/flutter/components/app-bars-top" target="_blank">アップバー</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/9f8c7a7e86f0e2ba.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://material.io/develop/flutter/components/bottom-navigation" target="_blank">ボトムナビゲーション</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/81fe954aa822d209.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://material.io/develop/flutter/components/buttons" target="_blank">ボタン</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/60bd27a78a2f4f83.png"></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><a href="https://material.io/develop/flutter/components/floating-action-buttons" target="_blank">ﾌﾛｰﾃｨﾝｸﾞｱｸｼｮﾝﾎﾞﾀﾝ</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/79662543c7dc120.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://material.io/develop/flutter/components/cards" target="_blank">カード</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/33ffbff0fc0b1d40.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://api.flutter.dev/flutter/material/Chip-class.html" target="_blank">チップ</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/2e2dbbb7b1dbcb68.png"></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><a href="https://material.io/develop/flutter/components/data-tables" target="_blank">データテーブル</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/99dfada4e9abfe21.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://api.flutter.dev/flutter/material/showDatePicker.html" target="_blank">デートピッカー</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/67678ecdac488dc6.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://api.flutter.dev/flutter/material/Dialog-class.html" target="_blank">ダイアログ</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/9662a1231d940d78.png"></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><a href="https://api.flutter.dev/flutter/material/Divider-class.html" target="_blank">デバイダー</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/c550524ab09dbc1.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://material.io/develop/flutter/components/lists" target="_blank">リスト</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/2ef873b21a35bb74.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://api.flutter.dev/flutter/material/PopupMenuButton-class.html" target="_blank">メニュー</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/cd811abecd73e932.png"></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><a href="https://api.flutter.dev/flutter/material/Drawer-class.html" target="_blank">ナビゲーションドローア</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/a2d750da533c49a3.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://api.flutter.dev/flutter/material/LinearProgressIndicator-class.html" target="_blank">プログレスインジケータ</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/7d4589c2fb0ba017.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://material.io/develop/flutter/components/checkboxes" target="_blank">チェックボックス</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/9029b190e700eeda.png"></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><a href="https://material.io/develop/flutter/components/radio-buttons" target="_blank">ラジオボタン</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/fe7958d42940ca60.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://api.flutter.dev/flutter/material/Switch-class.html" target="_blank">スイッチ</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/5719dca14fb3795f.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://api.flutter.dev/flutter/material/BottomSheet-class.html" target="_blank">ボトムシーツ</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/4315c2c7b9a6b5a.png"></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><a href="https://api.flutter.dev/flutter/material/Slider-class.html" target="_blank">スライダー</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/bec8763b12438b5.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://material.io/develop/flutter/components/snackbars" target="_blank">スナックバー</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/7e43ef72f745cc9a.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://material.io/develop/flutter/components/tabs" target="_blank">タブ</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/f15069b833333a5a.png"></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><a href="https://material.io/develop/flutter/components/text-fields/" target="_blank">テキストフィールド</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/63339ba6218f3565.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://api.flutter.dev/flutter/material/Tooltip-class.html" target="_blank">ツールチップ</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/1241e00c4dc72b3.png"></p>
</td><td colspan="1" rowspan="1"><p><a href="https://api.flutter.dev/flutter/material/showTimePicker.html" target="_blank">タイムピッカー</a></p>
<p class="image-container"><img style="width: 186.00px" src="img/d614d4cc32dbb848.png"></p>
</td></tr>
</table>
<aside class="warning"><p><strong>ノート:</strong> Flutterにおけるマテリアルデザインについては下記URLも参考にしてください。</p>
<p><a href="https://material.io/develop/flutter" target="_blank">https://material.io/develop/flutter</a></p>
</aside>
<h2 is-upgraded>7. カラーテーマ</h2>
<p>マテリアルデザインはアプリのブランディングを統一的に進めるためにカラーテーマというしくみを採用し、アプリケーション全体で部品の色やフォントカラーを統一させることが可能です。逆に言うと、同じアプリでもカラーテーマを変えてイメージの異なるアプリとして仕上げることが可能ですので、アプリケーションのテンプレートを先に作っておいて様々なプロジェクトに応用する場合にもこのようなしくみは役に立つでしょう。</p>
<p>カラーテーマ：<a href="https://material.io/design/color/the-color-system.html" target="_blank">https://material.io/design/color/the-color-system.html</a></p>
<p>カラーツール：<a href="https://material.io/resources/color/" target="_blank">https://material.io/resources/color/</a></p>
<h2 is-upgraded>8. マテリアルデザインの発展</h2>
<p>マテリアルデザインは単なる画面と画面遷移にとどまらず、音声や機械学習に関するUIについても拡張し、ガイドラインを提供しています。</p>
<p>機械学習機能に関するマテリアルデザイン：<a href="https://material.io/design/machine-learning/understanding-ml-patterns.html" target="_blank">https://material.io/design/machine-learning/understanding-ml-patterns.html</a></p>
<p>音声に関するマテリアルデザイン：<a href="https://material.io/design/sound/about-sound.html" target="_blank">https://material.io/design/sound/about-sound.html</a></p>
<p>これらはスマホにかかわらず、スマートウォッチ、スマートスピーカーやスマートイヤフォン、スマートグラスなどにもマテリアルデザインを適用していこうという取り組みのあらわれであり、次章で紹介するFlutterという開発環境も同じ目的で開発が進められています。</p>


      </google-codelab-step>
    
      <google-codelab-step label="開発環境とインフラ選定根拠" duration="0">
        <p>本書では、開発環境にGoogleがオープンソースとして開発しているクロスプラットフォーム開発環境であるFlutterを、インフラ環境にはGoogle Cloud Platform上のモバイル開発用クラウドプラットフォームであるFirebaseを利用します。本章ではこれらを選定した根拠を記載し、ベンダーロックインを排除するための代替案をまとめます。</p>
<h2 is-upgraded>1. Flutterの選択根拠</h2>
<p>最近のスマホアプリ開発では「あらゆるデバイス向けにネイティブアプリを開発しメンテナンスをする」か「特定のクロスプラットフォームフレームワークを選択して一つのコードをメンテナンスする」かを選択する必要があると言われています。</p>
<p>「あらゆるデバイス向けにネイティブアプリを開発しメンテナンスをする」を選択しているのは現在スマホアプリをリリースする企業の80%に上り、ネイティブアプリ開発により得られる操作性のよさと引き換えにiPhoneとAndroid用に2つのソースコードで開発し、両プラットフォーム用に卓越したプログラマーを雇い、コストをかけて運用しています。一方「特定のクロスプラットフォームフレームワークを選択して一つのコードをメンテナンスする」を選択する場合、開発されるアプリケーションはネイティブアプリより操作性や機能は劣るが、両方をネイティブ開発するより半分程度のコストですむことになります。</p>
<p class="image-container"><img style="width: 601.70px" src="img/881ab2dcbc8d7e13.png"></p>
<p>参考）<a href="https://medium.com/@stefan.klerkx/why-choose-flutter-for-your-company-6b2e67a4a7d9" target="_blank">Why choose Flutter for your company?</a></p>
<p>しかし、Flutterは第三の選択肢として機能します。FlutterはDart言語でプログラミングすると完全にネイティブなiOS用コードとAndroid用コードを生成してくれます。さらにはこれをリアルタイムで行うため、開発したスマホアプリを動かしながらDart言語によるソースコードを修正し、画面を修正することができます（この機能をホットリロードといいます）。このようにFlutterを使うことで、ワンコードで同じUIのiPhoneとAndroid両方のネイティブアプリを開発することが可能になります。</p>
<p>またFlutterを選択することで得られるビジネス上のメリットを以下に示します。</p>
<ul>
<li>アプリ投入までの時間短縮：Flutterはワンコードでネイティブアプリを開発できるのはもちろん、マテリアルデザインをサポートしており画面実装に必要な部品を標準で利用することができることやインターネット経由でのAPI操作に適した非同期処理を直感的に操作しやすいDart言語の特徴により一定レベル以上のアプリを開発する際の開発スピードを早めることができます。</li>
<li>高品質のルックアンドフィール：Flutterはピクセルレベルのデザインの実装が可能であり、リッチなマテリアルデザインベースの部品やアニメーションのしくみを有しているので、デザイナーはフレームワークの制約で妥協することなくブランディングを優先して様々なアイデアのデザインを行うことができます。</li>
<li>手ごろなコスト：Flutterはオープンソースでコミュニティベースで開発されているため、ツール採用のために必要なコストはありません。また、Java開発者のようなオブジェクト指向言語経験者ならDart言語の学習はそれほど難しくなく、エンジニア育成コストもそれほど高くありません。</li>
<li>リーチとリテンション：リッチなデザインの操作性のよいネイティブアプリをiPhoneとAndroid向けに同時にリリースできるため、世の中のすべてのユーザにリーチできます。また使い勝手がよいアプリの提供によりユーザのリテンション（維持・保持）率もアップします。</li>
</ul>
<p>なお、Flutterと比較されるクロスプラットフォーム開発環境と特徴を以下に紹介します。</p>
<ul>
<li>Cordova: HTML5とCSS、JavaScriptを使ってiPhoneとAndroid共通のUI部分を実装し、プラットフォーム依存の部分をプラットフォームにあわせてプラグインとして開発することでクロスプラットフォームを実現します。そのため、操作性や機能に制限があり、ネイティブな機能を使う場合には両プラットフォーム用にプラグイン開発が発生します。</li>
<li>ReactNative: Facebookが開発したクロスプラットフォーム開発環境で、JavaScriptで開発をします。一つのコードからiPhoneとAndroid用のネイティブコードを生成しますが、生成に時間が発生し、ホットリロードができません。</li>
<li>Xamarin: マイクロソフトが開発するクロスプラットフォーム開発環境で、C#で開発をします。Flutterと同じくネイティブコードを生成し、最近ホットリロードにも対応していますが、描画スピードに乏しいのが欠点です。またコミュニティサポートが不十分であるため、Flutterほど情報があり、人気があるとはいえません。</li>
</ul>
<p>以上のことを総合的に判断し、Flutterをベストな選択であると考え採用しました。</p>
<aside class="warning"><p><strong>ノート:</strong> FlutterはiOSとAndroidの二台スマホプラットフォームとWebアプリケーションだけでなく、PC系のmacOS、Windows、Linuxやエンベッドデバイス、さらには「Fuchsia（フクシア）」と呼ばれるGoogleが新たに開発を計画しているマルチデバイスプラットフォームに対応するために進化を続けています。また、Flutter開発を支えるプラグインの対応プラットフォームをこの8種類に拡大していくための提案がコミュニティから公開されていたりします。</p>
<p><a href="https://docs.google.com/document/d/1LD7QjmzJZLCopUrFAAE98wOUQpjmguyGTN2wd_89Srs" target="_blank">https://docs.google.com/document/d/1LD7QjmzJZLCopUrFAAE98wOUQpjmguyGTN2wd_89Srs</a></p>
</aside>
<h2 is-upgraded>2. Firebaseの選択根拠</h2>
<p>本書で開発するレストランレビューアプリもそうですが、世の中のスマホアプリはインターネット上のサーバと連携してサービスを提供します。通常インターネット上のサーバはアプリに入力したデータを保存したり、アプリに表示するデータを提供するデータベースが主要な機能になりますが、スマホアプリからのアクセスに通常のWebアプリが採用しているODBCやJDBCのようなしくみを選択するのはセキュリティ上の理由からも推奨されません。そのため、アプリからのアクセスの際、テーブルへのCRUDのどの機能が必要かを考えてAPIを開発し、さらに認証認可のしくみを実装することが必要になります。</p>
<p>一方、Firebaseは、アプリにログインする認証のしくみ（Firebase Auth）とアプリと安全にコネクションを繋いだままストリーム処理が可能なデータベース（Firestore）、写真などの大きめのバイナリファイルを保存するためのストレージ（Firestorage）といったサービスを提供します。またクライアント用には、Firebase Authで認証されたユーザIDと紐づけてFirestoreデータベースにデータを保存したり、FirestorageのURIをFirestoreデータベースに保存して利用する機能を、様々なプログラミング言語向けに標準的なSDKとして提供されています。そのため、一からバックエンドのサービスを開発するのに比べ、基本的な機能をほとんど開発する必要がないため、開発工数を劇的に削減することができます。</p>
<p>さらには、FirebaseはA/Bテストを行う機能やスマホアプリのクラッシュログを収集する機能、ユーザがどの画面のどのボタンをクリックしたかといった動線を集計する機能、スマホアプリをテストユーザに配布する機能などモバイルアプリ用に豊富な機能を安価に提供しているため、多くのモバイルアプリ開発者に採用されています。</p>
<p>以上の理由から本書ではバックエンドの機能にFirebaseを採用することにしました。</p>
<h2 is-upgraded>3. ベンダーロックインの排除</h2>
<p>企業におけるITツールの選定で気をつけるべき点にベンダーロックインの排除が挙げられます。というのも、採用技術の開発が止まったり急に利用コストが値上げされ別の方法を模索しなければならなくなったり、アプリを横展開して他社に提供する場合先方のプラットフォームにあわせなければならない、といったことがありうるため、採用時のメリデメだけでなく他に乗り換える可能性も考慮しなければなりません。</p>
<p>まず開発環境としてのFlutterについては、100%オープンソースであり、プロジェクトがストップしたりいきなり有料サービスになることは、いまとなってはまずあり得ないため、Flutterを採用することによるベンダーロックインはありえないと考えてよいでしょう。</p>
<p>一方、Firebaseについてはアプリの横展開をする際にクラウドサービスを使いたくないケースが考えられるので、なんらかの代替案を考える必要があります。Firebaseのサービスごとに代替案を以下に紹介します。</p>
<ul>
<li>Firebase Auth：独自に認証サーバを立ち上げたり、Keycloakのような統合認証認可サービスを立ち上げてユーザ管理をすることで代替できます。</li>
<li>Cloud Firestore：認証のしくみはKeycloakのクライアントプラグインを使って実装することで実現できます。ドキュメント型データベースとしてmongoDBがあげられるので、ストリーム型でアプリから連携できるようgRPCで公開し、Dart言語のgRPCクライアントを開発しFlutterで利用することで実現できます。ただし、Firestoreで実現しているセキュリティルールやオフライン機能や差分のみをやりとりする機能などの高度な機能の実装は困難なので、アプリの使い勝手は悪くなると思われます。</li>
<li>Firebase Storage：Keycloakのような認証サービスと連携してストレージサービスを開発するのは難しいので、データベースにサイズを小さくしたバイナリとして保存するようにするとよいでしょう。</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="NoSQLとFirestoreについて" duration="0">
        <p>Googleが公開している12コマの動画シリーズをベースにNoSQLデータベースとFirestoreを解説します。</p>
<h2 is-upgraded>動画の全体像</h2>
<p>ここで紹介する動画シリーズは、GoogleのTodd Kerpelman氏による「<a href="https://www.youtube.com/playlist?list=PLl-K7zZEsYLluG5MCVEzXAQ7ACZBCuZgZ" target="_blank">Get to know Cloud Firestore</a>」という動画シリーズで、Firestoreを使い始めるにあたって知っておくべきことを12回にわたって解説しているものです。本書に添付された動画は全画面表示が可能ですし、英語の字幕を自動表示する設定になっていますが、英語が苦手な人はYoutube画面の右下の設定で字幕をONにし、さらに字幕の自動翻訳を選び日本語を選択して日本語字幕を表示することも可能です。</p>
<h2 is-upgraded>1. NoSQLの特徴</h2>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/v_hR4K4auoQ?cc_load_policy=1<p>v_hR4K4auoQ</p>amp;cc_lang_pref=ja" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<ul>
<li>従来型のリレーショナルデータベースではテーブルのスキーマが厳格に定義され、正規化という手法でデータの重複が発生しないようテーブル分割します。分割されたテーブルが互いに関係を持つ場合、一方のプライマリキーを他方が外部キーとして持つことで1対多の関係を構成します。例えば「レストラン」と「顧客」と「顧客によるレストランのレビュー（以下「レビュー」）」の3テーブルあるとして「レビュー」は「レストラン」と「顧客」を外部キーとして持つことで「レビュー」テーブルが「レストラン」と「顧客」の間の中間テーブルとして機能します。こうすることで、「レストラン」は「顧客」から0個以上の複数「レビュー」を受け、「顧客」は0個以上の複数「レストラン」に対して「レビュー」を行える、といった多対多の関係を表現することができるわけです。</li>
</ul>
<p class="image-container"><img style="width: 549.00px" src="img/ffa6d83682381ec7.png"></p>
<ul>
<li>一方、NoSQL型データベースには様々なタイプがあるものの、主に「スキーマレス」という特徴を持ち、テーブル定義のような厳格なスキーマをあらかじめデータベース側に定義する必要はありません。ただし、NoSQL型データベースでも上記のようなテーブル間のリレーションは重要概念で、クライアントアプリ側のデータベースアクセス部分（いわゆるCRUD操作する部分）を正しく開発するためにテーブル間の関係を設計する必要があります。しかし「スキーマレス」の特徴のため、アプリのリリース後にテーブルに新たなフィールドを追加したくなった場合はアプリの修正だけで対応が可能で、リレーショナルデータベースの時代のようにデータの移行を考慮しながらデータベースに対してスキーマ定義を更新するといった作業が必要ないといった利点があります。</li>
<li>またNoSQL型データベースにはSQL文がありません。例えばコレクションとドキュメントのツリー構造からなるドキュメント型データベースでは、ドキュメントの階層をたどって検索を行うことで目的のドキュメントにたどりつくといったしくみでデータ操作を行います。そのため、リレーショナルデータベースでは正規化してきれいにテーブル分離する一方、同時に頻繁に検索対象となりうるフィールドをあえて親子のドキュメント間で重複して持つといった非正規化を行い、一つの検索で目的の情報にたどりつけるようにすることが、ドキュメント型データベースにおいては推奨されることがあります。例えば、レストランのレビューをリスト表示する場合で考えると、レビューにそれを行った顧客の名前フィールドをのせておくといったことです。こうすることで、レビューに登録された顧客IDから顧客ドキュメントを検索し、顧客の名前までたどるといった処理が必要なくなります。</li>
<li>ただしデータの重複保存は、表示の際の検索回数を削減できますが、データの一貫性を失わせます。重複しているフィールドの更新や削除の際、重複して保存された箇所すべての更新や削除を行うことを忘れないよう注意が必要です。これらデータの重複保存の設計は、参照の頻度と更新や削除の頻度のトレードオフを考慮して行います。</li>
<li>以上のとおり、リレーショナルデータベースとNoSQL型データベースにはそれぞれ利点と欠点がありますが、NoSQL型データベースの大きな利点として水平スケーリングが可能ということが挙げられます。この特徴により、アプリが人気になりデータアクセス数やデータ量が大きく増加した場合、NoSQLだとサーバの数を増強するだけで対応（これを水平スケールという）でき、サーバのコピーによる自動スケールが可能となり、運用保守の人件費やシステムの停止リスクが削減できます。</li>
<li>いままでデータベースにおいてもっとも大切と言われてきたデータの一貫性担保を一部犠牲にしたとしても、このようなクラウド時代においてNoSQLデータベースが求められる背景には、スケーラビリティへの要望やスキーマレスによる変更への柔軟に対応できるといったメリットが挙げられます。</li>
<li>Cloud Firestoreでは、NoSQL型データベースの中でもドキュメント型データベースを採用しています。ドキュメント型データベースでは、コレクションとドキュメントのツリー構造で構成され、JSONの配列とオブジェクトで表現することができます。これらコレクションとドキュメントの説明は、<a href="https://cloud.google.com/firestore/docs/data-model?hl=ja" target="_blank">Firebaseのデータモデル</a>を参照してください。</li>
</ul>
<h2 is-upgraded>2. クエリによる検索</h2>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/Ofux_4c94FI?cc_load_policy=1<p>Ofux_4c94FI</p>amp;cc_lang_pref=ja" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<ul>
<li>データベースに検索を行ってデータを取得する操作のことをクエリと呼びます。一般的なドキュメント型データベースでは、一回のクエリの検索対象となるデータの範囲は検索対象ドキュメントが所属するコレクション内のみになります。以前に説明したコレクションとドキュメントの関係を思い出してもらいたいのですが、コレクションはドキュメントを含みますが、ドキュメントに直接ドキュメントを紐づけることはできず、必ずコレクションを挟みます。例えばレストランのレビューのケースのレストランとレビューの関係は下図のようになります。</li>
</ul>
<p class="image-container"><img style="width: 591.38px" src="img/a9e271f6dcff33fb.png"></p>
<ul>
<li>ここで注目してもらいたいのが各レビュー・コレクションはそれぞれのレストラン・ドキュメントに紐づいているので、すべてのレビューを対象に例えば星4以上など星の数を指定して一括検索することができません。この理由としては、NoSQLデータベースの特徴と言えますが、上のようなツリー構造のため、ドキュメントのインデックスはドキュメントを含むコレクション単位で作成されるためです。そのため、同じレビューだからといって隣のコレクションも含めて検索しようとしてもそれは対象外となってしまうわけです。同一名のコレクションを横断的に検索することはSQLではできたことで、レビュー・テーブルは正規化により一つだけ存在し、インデックス化もまとめて行われているのがそれができる理由です。</li>
<li>横断的な検索を可能にするため、Firestoreではコレクショングループという機能を用意しています。サブコレクション（上図のレビュー・コレクションに相当）において検索キーとして機能させたいフィールド（上図では「星の数」フィールド）を指定することでコレクション・グループ検索が可能になります。ただし、このコレクショングループに指定するフィールド数が増えれば増えるほどデータ更新時にインデックス処理がたくさん走るため更新に時間がかかってしまうこと、またFirestoreではコレクション・グループに指定できるフィールド数が200個までという制限があります。また、Firestoreデータベースツリー内に同一名のコレクションが複数あると、それら全てを含めてインデックス化してしまうことに注意が必要です。そのため、一つのFirestoreデータベースで利用するコレクション名は重複しないよう設計しましょう。コレクショングループの設定方法は<a href="https://qiita.com/96wver/items/8eb0c79647529fe5fc75" target="_blank">こちら</a>を参考にしてください。</li>
</ul>
<aside class="warning"><p><strong>ノート: </strong>コレクション・グループに指定できるフィールド数の上限は200です。</p>
<p><a href="https://firebase.google.com/docs/firestore/query-data/index-overview?hl=ja" target="_blank">https://firebase.google.com/docs/firestore/query-data/index-overview?hl=ja</a></p>
</aside>
<ul>
<li>Firestoreはドキュメント内のすべてのフィールドが（マップ内のフィールドも含めて）自動的にインデックス化されるので、値の全文一致や上方一致、数値の大小で検索することは非常に高速で行えます。一方、SQL文の&#34;LIKE %(値)%&#34;のような部分一致を行う機能を持っておらず、下記のリンクのような工夫が必要です。<a href="https://qiita.com/oukayuka/items/d3cee72501a55e8be44a" target="_blank">https://qiita.com/oukayuka/items/d3cee72501a55e8be44a</a></li>
<li>またFirestoreの別の制限として&#34;!=&#34;が含まれるクエリや論理ORのクエリを行うことができません。例えば、星の数が満点5であるが書き込み数が少ないとフェイクかもしれないので、それらを除外する検索条件として「星の数が4以上5より少ない、もしくは、星の数が5でレビュー数が3以上のレビュー」を検索したいとしてもFirestoreではそれができません。そのため「星の数4以上5より小さいレビュー」と「星の数5でレビュー数が3以上」を検索して、クライアント側でマージして、重複データがあればクライアント側でそれを差し引きしなければなりません。もしくはこの検索条件を見越して新しいフィールド「満点疑惑」といったものを追加して、レビュー書き込み時に星の数5でレビュー数2以下の場合「満点疑惑」の値を疑惑があるといういみで「true」に設定し、検索時には星の数が4以上かつ「満点疑惑」が「false」を検索するようAND条件で検索できるよう工夫する必要があります。</li>
</ul>
<aside class="warning"><p><strong>ノート: </strong>論理ORを実行したい場合の方法としては、検索対象のフィールドをwhere句のwhereInをつかって指定した配列のいずれかを含む値のリストを取得します。また、検索対象のフィールドを配列で構成してarrayContains関数（データベース上のフィールドの配列に検索条件の値が含まれるかをチェック）やarrayContainsAny関数（データベース上のフィールドの配列に検索条件の配列値のいずれかが含まれるかをチェック）を使う方法が考えられます。ただし、一つの検索文の中でarrayContainsAnyは一つしか使えないこと、whereInやarrayContainsは10個が上限であることに注意が必要です。</p>
<p><a href="https://cloud.google.com/firestore/docs/query-data/queries?hl=ja#in_and_array-contains-any" target="_blank">https://cloud.google.com/firestore/docs/query-data/queries?hl=ja#in_and_array-contains-any</a></p>
<p>論理ORを実行したい場合の別の方法として、クエリをわけて実行してあとからくっつける方法もあります。</p>
<p><a href="https://stackoverflow.com/questions/58191550/flutter-dart-querysnapshot-isequalto-or-operator" target="_blank">https://stackoverflow.com/questions/58191550/flutter-dart-querysnapshot-isequalto-or-operator</a></p>
</aside>
<ul>
<li>さらにFirestoreのクエリで注意が必要なケースとして「複合クエリ」が挙げられます。複合クエリとはwhere文を複数つないでAND検索を行うことをあらわしますが、このとき複数種類のフィールドで範囲比較（&#34;&lt;&#34;, &#34;&lt;=&#34;, &#34;&gt;&#34;, &#34;&gt;=&#34;）やarray-contains句（配列に値を含むかという意味）を適用する場合は、それら複数フィールドの組み合わせでインデックスを作成しておく（これを複数インデックスと呼ぶ）必要があります。Firestoreのデフォルト機能としてあらかじめドキュメントのすべてのフィールドの組み合わせで複合インデックスを作っておくという案も考えられますが、これらの組み合わせ数は莫大な数になりうるため、検索の要件にあわせて複合インデックスを行うことになっています。</li>
<li>Firestoreの便利な機能としては、もしこの複合インデックスの設定がない状態でクライアントから複合クエリを実行した際、エラーメッセージとともにFirestore上の複合インデックス作成画面へのURIを返してくれるので、そのリンクをたどって設定を行い次からはエラーを回避することができます。</li>
<li>以上をふまえた上でFirestoreのクエリについてさらに確認したい場合は下記のオフィシャルドキュメントを参照してください。<a href="https://firebase.google.com/docs/firestore/query-data/queries" target="_blank">https://firebase.google.com/docs/firestore/query-data/queries</a></li>
</ul>
<h2 is-upgraded>3. コストの考え方</h2>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/6NegFl9p_sE?cc_load_policy=1<p>6NegFl9p_sE</p>amp;cc_lang_pref=ja" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<ul>
<li>Firestoreでは、ドキュメントの読み込み数(10万回あたり0.06ドル)、ドキュメントの書き込み数(10万回あたり0.18ドル)、ドキュメントの削除数(10万回あたり0.02ドル)といったドキュメントの処理数単位で課金がなされます。</li>
<li>このような課金システムの場合、リスト画面の更新を行う際、リクエストレスポンス型のアクセスを行うと、データベース上のデータ更新部分が一部であったとして、更新されてないものも含め表示対象の全データをまとめて読み込むことになるのでコスト的に大変効率が悪くなります。このあとペジネーションのところで説明しますが、Firestoreでは、データアクセスをリアルタイムデータベースとのストリームとして扱い、クライアント側のキャッシュを有効利用して更新が発生したデータのみをやりとりします。これによって差分の読み書き分だけが課金され、全データ取得型より大幅にコストを削減することができます。</li>
<li>さらに、Google Cloud ConsoleのApp Engine画面にて、Firestoreの利用量と時間ごとの課金料金を確認することができます。また、利用料金の閾値を設けてそれを超えたらアラートメールを送ってくれるような設定を行うこともできるので、うまく運用保守で利用するとよいでしょう。</li>
</ul>
<h2 is-upgraded>4. マップと配列とサブコレクション</h2>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/o7d5Zeic63s?cc_load_policy=1<p>o7d5Zeic63s</p>amp;cc_lang_pref=ja" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<h3 is-upgraded>Firestoreにおけるルール</h3>
<p>Firestoreでは、JSONの構造における配列（[]で表す）とマップ（{}で表す）をドキュメント型リアルタイム・データベースとしてうまく操作できるようコレクション（JSON内の配列に相当）とドキュメント（JSON内のマップに相当）にうまく分離して保存管理するよう設計します。この設計をうまく行うためにはFirestoreにおけるいくつかのルールを理解しておく必要があります。</p>
<h3 is-upgraded><strong>ルール1: ドキュメントには制約がある</strong></h3>
<ol type="1" start="1">
<li>ドキュメント1つあたり1MB制限あります。そのため、画像ファイルなど大きなファイルはFirebase firestorageに置きファイルパスをドキュメントに保存することで回避します。</li>
<li>ドキュメント1つあたり最大フィールド数は2万までの制限があります。普通1ドキュメントにそんなに大量のフィールドは必要ないでしょうが、例えばレストラン・ドキュメントにレビューデータも含めるといった設計にすると、有名なレストランではレビューデータが膨れ上がってこの制限を超えてしまうといったことがありえます。ドキュメント内のフィールドは書き込みや更新があるとその都度インデックス処理が走りますが、フィールド数が多すぎるとその処理にオーバーヘッドがかかってしまうという理由からもこの制約が設けられています。以上の理由からも、レビューのように1ドキュメントの配下に大量の配列がぶら下がるような構成の場合は、配列をコレクションとして分割するようにします。</li>
<li>ドキュメント1つあたり書き込み回数は1秒間に1回のみという制限があります。異なるドキュメントへの書き込みは並列処理されますが、同一ドキュメントへの複数からの同時書き込みは並列処理され1秒間に1回のみであり、同時に行われた書き込み処理は失敗するのでクライアント側で再試行する必要があります。</li>
</ol>
<h3 is-upgraded><strong>ルール2: 検索結果はドキュメント全体が出力される</strong></h3>
<ul>
<li>アプリ表示のときタイトルだけ欲しいケースがありますが、ドキュメント内の一部のフィールドだけを取得することはできず、全フィールドデータが送られてきます。これを回避したければドキュメントを分割する必要があります。</li>
<li>同じことはセキュリティルールにも言え、ドキュメント内の一部のフィールドだけ異なるアクセス権を付与するといった操作はできません。異なるセキュリティルールを設定したい場合、たとえドキュメント内で配列構造を持たない箇所でもコレクション配下の1ドキュメントとして分割して対応します。</li>
</ul>
<h3 is-upgraded><strong>ルール3: 検索対象は浅い</strong></h3>
<ul>
<li>一度のクエリでは、データベース全体でなくコレクション内のドキュメントだけが検索対象となります。そのためレビュー・リストに投稿した顧客名を表示したいような場合は、顧客ドキュメントの名前フィールドの情報をレビュー・ドキュメントにも用意する、といった非正規化が効果的となるでしょう。</li>
<li>2019年からコレクショングループの機能が追加され、「collectionGroud(&#34;コレクション名&#34;).where(...).getDocument)」といったクエリを使って子の情報から親を検索できるようになりました。</li>
</ul>
<h3 is-upgraded><strong>ルール4: 課金はドキュメントの読み書き回数でカウントされる</strong></h3>
<ul>
<li>Firestoreでは前述したとおりドキュメントの読み込みと書き込みの回数の合計で課金される金額が決まります。</li>
<li>ルール3のため、一度に表示したい情報が複数ドキュメントに分割されていると、一つにまとまっているよりも数倍の回数の読み込みが発生して課金が発生するので注意が必要です。</li>
<li>ただし、トランザクション数が少なく課金への影響が少額である部分の設計や実装にこだわるのは、設計者や開発者、運用者の人件費を考えると逆に無駄なことになりうることも念頭におき、ほどほどに設計するのがよいでしょう。</li>
</ul>
<h3 is-upgraded><strong>ルール5: 配列操作は奇妙である</strong></h3>
<ul>
<li>例えば、arr: [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;]という配列は要素arr[1]を削除すると[&#39;a&#39;,&#39;c&#39;]に変わるが&#39;c&#39;に注目して考えるとarr[2]だったものがarr[1]に変わってしまいます。</li>
<li>配列要素に追加や削除があると、複数人でデータを扱う際一元的にデータ参照できないという問題があります。</li>
<li>解決策としては、ドキュメントはドキュメントIDを使って更新や削除を行うとよいでしょう。</li>
</ul>
<p>参考）<a href="https://firebase.googleblog.com/2014/04/best-practices-arrays-in-firebase.html" target="_blank">https://firebase.googleblog.com/2014/04/best-practices-arrays-in-firebase.html</a></p>
<h2 is-upgraded>5. データ構造</h2>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/haMOUb3KVSo?cc_load_policy=1<p>haMOUb3KVSo</p>amp;cc_lang_pref=ja" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<p>ドキュメント型データベースにおいて、ユースケースに適したデータ構造を設計するとき主に以下の3種類の構造から適切なものを選びます。</p>
<h3 is-upgraded><strong>タイプ1. ドキュメントの一部として配列もしくはマップとして含める</strong></h3>
<ul>
<li>例えば、レストラン・ドキュメントに最も星の数が多い5つのレビュー内容や最新の5つのレビュー内容をマップか配列として含めることも可能です。</li>
<li>利点としては、ドキュメントの一度の検索で表示すべき情報を取得することができることが挙げられます。</li>
<li>一方欠点としては、時間経過とともにフィールド数が増大し、更新時のインデックス処理に時間がかかるようになり、最終的には1ドキュメントあたり1MB制限や2万フィールド制限に到達してしまうことがあります。</li>
</ul>
<h3 is-upgraded><strong>タイプ2. オブジェクトをサブコレクションにおさめる</strong></h3>
<ul>
<li>例えば、レストランのレビューは大量の書き込みが行われる可能性もあるためレストラン・ドキュメントのサブコレクションに含めるとよいでしょう。</li>
<li>利点としては、リストが大きくなっても親ドキュメントのサイズが変わらず、複数のサブコレクションにまたがる検索をする場合は、<a href="https://cloud.google.com/firestore/docs/query-data/queries?hl=ja" target="_blank">コレクション グループ </a>を設定するとよいでしょう。</li>
<li>一方、欠点としては、ドキュメントをまたがって検索することが常である場合にも読み込み回数がドキュメント数分発生してしまうことが挙げられます。</li>
</ul>
<h3 is-upgraded><strong>タイプ3. オブジェクトをルートレベルのコレクションにおさめる</strong></h3>
<ul>
<li>例えば、レビューを書き込む顧客はこのアプリケーションのユーザであり、例えばアプリに出前機能が追加された際にも再利用する必要があるかもしれません。そういう意味でもルートレベルのコレクションとして整理するとよいでしょう。</li>
<li>利点としては、ルートレベルのコレクションはリレーショナルデータベースにおける正規化の考え方と同じく再利用しやすく、アプリの作り方によらずデータの一貫性が保たれ安心できます。</li>
<li>一方欠点としては、データが階層的になっていることから、データベースが拡大するにつれ、データの取得が難しくなる可能性があります。例えば、20才未満の顧客が4以上の星をつけたレストランを検索するのは簡単ではないので、必要となりそうな検索条件にあわせてレビュー・ドキュメントにも重複して顧客情報を持つよう設計するとよいでしょう。</li>
<li>データ構造については、下記のオフィシャル・ドキュメントも参照するとよいでしょう。</li>
</ul>
<p><a href="https://cloud.google.com/firestore/docs/concepts/structure-data?hl=ja" target="_blank">https://cloud.google.com/firestore/docs/concepts/structure-data?hl=ja</a></p>
<h2 is-upgraded>6. セキュリティルール</h2>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/eW5MdE3ZcAw?cc_load_policy=1<p>eW5MdE3ZcAw</p>amp;cc_lang_pref=ja" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<ul>
<li>Firestoreでは、データベースのツリー構造のドキュメント位置を指定して誰がCRUD（Create:作成、Read:読み込み、Update:更新、Delete:削除）できるかを指定します。これらのアクセス権の指定はセキュリティルールといい、拡張子&#34;.rules&#34;のファイルに設計してFirestoreにデプロイして適用します。</li>
<li>データベース内で、フィールドレベルのアクセス権をIF文を使った複雑な条件文と共に直感的にルール化できるのは、リレーショナルデータベースにはない機能です。APIの開発をしなくてもクライアントから共通化されたSDKを使ってリアルタイムデータベースとしてアクセスできる、といったことを含めて、Firestoreはモバイル開発に最適なデータベースのひとつであると言えるでしょう。</li>
<li>このセキュリティルールでは、データベースのルートからのドキュメントへのパスを指定し、ドキュメントは{xxID}や{xxID=**}のようにID名（自由に命名できます）とワイルドカードを使って指定します。ここで{}内で指定した変数名(xxID)はドキュメントをあらわし、そのドキュメントに含まれるフィールドをキーにしてIF文の中でアクセス条件を指定することができます。またルールの中では「get(ドキュメントへのパス)」を指定して、指定したドキュメントのフィールド値にもアクセスできます（例えばログインユーザのロールなど）。</li>
<li>これらのルールは複雑で再利用したくなる場合がありますが、カスタムファンクションという関数を定義して、例えばGoogleアカウントかどうかをチェックするといった処理を関数化してルールファイル内で再利用することができます。</li>
<li>セキュリティルールはアクセス権の設定が主な目的ですが、このしくみを使うと書き込みや更新時に空白を受け付けないフィールドを指定したり、メールアドレスの形式のチェック、さらには1顧客が書き込みできるレビューの数を100件までに制限するといったデータバリデータとして利用することも可能です。そのため、プロジェクトごとにどこまでセキュリティルールに設定を行うかをあらかじめ決めておくとよいでしょう。</li>
<li>ルールファイルはアプリ内で想定通り動作することを担保するために単体テストを自動化するよいでしょう。その場合、Firebaseエミュレータを使ってテストすることをおすすめします。そうすれば、自動テストのために課金が発生するといったことを避けられます。</li>
<li>セキュリティルールについては、下記のオフィシャル・ドキュメントも参照するとよいでしょう。</li>
</ul>
<p><a href="https://cloud.google.com/firestore/docs/security/get-started" target="_blank">https://cloud.google.com/firestore/docs/security/get-started</a></p>
<p><a href="https://firebase.google.com/docs/reference/security/database" target="_blank">https://firebase.google.com/docs/reference/security/database</a></p>
<h2 is-upgraded>7. データのペジネーション</h2>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/poqTHxtDXwU?cc_load_policy=1<p>poqTHxtDXwU</p>amp;cc_lang_pref=ja" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<ul>
<li>一般的に、アプリケーションが表示に必要なレコード以上のデータを取得すると無駄な読み込みに課金が発生し、ネットワークを流れるデータ量も増えるため、サーバ側でペジネーションを行うことが推奨されます。</li>
<li>Firestoreではストリーミング・データベースとして機能し、高度なペジネーション機能を提供します。というのも、クライアントとストリーミングとしてコネクションを維持している場合、常にクライアント側のキャッシュとの差分をチェックして更新分だけをやりとりしてくれる機能を持っています。また、リストを表示する画面があったとして、画面に表示されていない表の下部や上部をスクロール操作で表示したいとき、リアルタイムデータベースはスクロール操作にあわせて必要なデータをストリーム取得してくれます。</li>
<li>具体的には「Query.start(after:previousDoc)」といった関数が、いま表示されているドキュメントの続きををよしなに判断して取得します。このようにFirestoreのSDKを使うことで、他のクライアントがコレクションに新たなドキュメントを追加したり、既存のドキュメントを削除したりする場合にも、SDKがよしなに差分データだけを取得して画面に反映してくれるため、開発者は難しいことを考えることなくリアルタイムデータベースの効率的で高度な機能を実装できます。</li>
<li>例えばFlutterでは、「Firestore.instance.collection(&#39;コレクション名&#39;).snapshots()」といった関数でストリーム型でデータを取得し、ListViewやGridViewで表示させることでペジネーションの実装が可能です。</li>
</ul>
<h2 is-upgraded>8. トランザクション処理</h2>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/dOVSr0OsAoU?cc_load_policy=1<p>dOVSr0OsAoU</p>amp;cc_lang_pref=ja" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<ul>
<li>Firestoreはトランザクション処理を実現します。例えば、顧客ドキュメントの名前フィールドを更新する際、レビュードキュメント上においたレビューを追加した顧客名も同時に更新しなければならないことがあります。このような場合、一連の更新作業はひとつのトランザクションとし、すべてが成功した場合にのみ更新を確定（コミット）するといった機能が必要です。そうしなければ、途中の更新に失敗した場合データに不整合が発生してしまいます。</li>
<li>Firestoreにおけるトランザクションの考え方には以下の2種類があります。</li>
</ul>
<ol type="1" start="1">
<li>バッチ書き込み：複数ドキュメントに同時書き込みを行いたいときクライアントはそれらをまとめて送り、処理中ドキュメントはロックされトランザクションを実現</li>
<li>楽観的平衡性制御：特にモバイルデバイスでは急なネットワーク停止がありうるため、クライアントからのロック指示は行わず、読み込み→書き込み→読み込み→一貫性チェック→コミットといった順でトランザクション処理を行います。失敗の際は、データベースはロールバックし、クライアント側は再実行で対応します。</li>
</ol>
<ul>
<li>トランザクション対応機能として、ドキュメントに数値フィールドを持ち、その増加と減少にトランザクション処理を施したい場合、FieldValue.increment()を使うと簡単にトランザクションを担保できます。</li>
</ul>
<p>参考）</p>
<ul>
<li>オフィシャルドキュメント：<a href="https://firebase.google.com/docs/firestore/manage-data/transactions?hl=ja" target="_blank">https://firebase.google.com/docs/firestore/manage-data/transactions?hl=ja</a>i</li>
<li>Firestoreでのトランザクションの考え方、必要性：<a href="https://qiita.com/1amageek/items/2eff436fb69bea5875ea" target="_blank">https://qiita.com/1amageek/items/2eff436fb69bea5875ea</a></li>
<li>FieldValue.increment()による高速トランザクション：<a href="https://qiita.com/1amageek/items/665df5a6d9921319e300" target="_blank">https://qiita.com/1amageek/items/665df5a6d9921319e300</a></li>
</ul>
<h2 is-upgraded>9. オフラインサポート</h2>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/oDvdAFP6OhQ?cc_load_policy=1<p>oDvdAFP6OhQ</p>amp;cc_lang_pref=ja" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<ul>
<li>Firestoreはオフラインをサポートしており、クライアント側にFirestore SDKを使うとオフライン時の読み込みはキャッシュが使われ、書き込みもローカルに保存されオンラインになったら順番にFirestoreに反映されるといったことが実現可能です。</li>
<li>これらの機能は大変高度なものであり、実装するには大変な工数がかかり考慮点も多数ありますが、Firestoreではデフォルトでこれらの機能が利用できますです。</li>
</ul>
<h2 is-upgraded>10. リアルタイムか一括フェッチか？</h2>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/3aoxOtMM2rc?cc_load_policy=1<p>3aoxOtMM2rc</p>amp;cc_lang_pref=ja" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<ul>
<li>リアルタイムデータベースの操作について下記の迷信がありますが、Firestoreはこれらの迷信を覆します。そのためFirestoreにおいてはデフォルトでリアルタイム機能を使うよう設計し開発をすすめることをおすすめします。</li>
</ul>
<ol type="1" start="1">
<li>コーディングが難しい</li>
</ol>
<p>いいえ。Firestore用SDKがストリーム処理をしてくれるので使い方を覚えれば実装は簡単です。</p>
<ol type="1" start="2">
<li>リアルタイム処理だと読み込み数が増え課金が増える</li>
</ol>
<p>いいえ。更新された分だけが読み込み数にカウントされ、むしろ全部を読み込む方式の方が課金されます。リアルタイム処理の方が一般的に課金が少なくなります。</p>
<ol type="1" start="3">
<li>デバイスの電力消費が大きい</li>
</ol>
<p>いいえ。リスナーを常駐させることは電力消費を増やしません。</p>
<h2 is-upgraded>11. サーバレスの概要（Cloud Functions）</h2>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/rERRuBjxJ80?cc_load_policy=1<p>rERRuBjxJ80</p>amp;cc_lang_pref=ja" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<ul>
<li>Firesoteは、Firebase上のドキュメント型リアルタイムデータベースを提供するサービスであり、リレーショナルデータベースをモバイルアプリから利用する際に通常必要となるAPIの開発を必要としません。しかし、異なるドキュメントに重複して所有されるフィールドの更新時に一貫性を持たせるための更新処理を実行したい場合や古いデータをまとめて削除するといった運用バッチを実行したい場合など、バックエンドでまとめて処理を行いたいといった要望があります。</li>
<li>Firebaseでは、そのような場合に利用できる機能としてFirebase Functionsというサービスを提供しています。また、Firebase Functionsは一過性のバッチ処理を実行するものであるため、コンピュータ上にプロセスが常駐しないサーバレス型で実装されています。そのため、使った分だけの課金であるのはもちろん、プロセスの常駐に必要なCPUやメモリ、ストレージへの課金がまるまる削減されます。</li>
<li>Firebase Functionsでサポートされるプログラミング言語はJavaScriptとTypeScriptですが、バグを防ぐためにも型の定義がしっかりしているTypeScriptの利用がおすすめでJavaScriptに似た言語のため言語の習得も容易です。</li>
<li>Firebase Functionsは想定通り動作することを担保するために結合テストを自動化するよいでしょう。その場合、Firebaseエミュレータを使ってFirestoreのエミュレータとつなげてテストすることをおすすめします。そうすれば、自動テストのために課金が発生するといったことを避けられます。</li>
<li>Firebase Functionsの詳細については、下記の動画「TypeScriptを使ってCloud Functionsを始めよう」も参照するとよいでしょう。</li>
</ul>
<p><a href="https://www.youtube.com/watch?v=DYfP-UIKxH0" target="_blank">https://www.youtube.com/watch?v=DYfP-UIKxH0</a></p>
<h2 is-upgraded>12. Cloud Functionsの5つの利用パターン</h2>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/77XmRDtOL7c?cc_load_policy=1<p>77XmRDtOL7c</p>amp;cc_lang_pref=ja" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<ul>
<li>Cloud Functionsをどのような場合に利用すればよいか、5つのパターンにまとめると以下の通りです。ただし繰り返しになりますがリアルタイムデータベースのメリットが享受できなくなる欠点があることは考慮すべきでしょう。</li>
</ul>
<ol type="1" start="1">
<li>セキュリティルールを単純化したい場合：複雑なアクセスが関数にまとめられるのでセキュリティルールにこれを指定することでことたります。</li>
<li>分散データを更新したい場合：例えば、顧客の名前フィールドを更新するとき、同時にレビュー上の編集者の名前フィールドも更新しなければならない場合、Cloud Functionsで更新することで一貫性を保つことができます。</li>
<li>定期メンテナンスを行いたい場合：日次でメンテナンス用のcronを実行するようなイメージです。例えば、レストランの星の数の平均を日次で計算してレストランの平均星の数フィールドに更新をかける、といったものです。</li>
<li>レガシーデータベースとの連携：レガシーなデータベースが別にあり、Firestoreにデータをレプリケーションしてアプリの読み取り用に使う、といったケースです。</li>
<li>カスタムAPIの作成：用途限定でCloud Functionsを作成するとクライアントアプリの実装がシンプルになり効率化するといったメリットがありえますが、オフライン機能が失われるといったデメリットとのトレードオフを考慮して採用を決めるとよいです。</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="Flutterによるアプリ開発" duration="0">
        <p>ユースケースの整理からデータモデルと画面設計ができたらアプリケーションの開発をはじめます。</p>
<p>本書では、一つのソースコードでiPhoneアプリとAndroidアプリ、Webアプリ、パソコン用ネイティブアプリ、スマートデバイスようアプリ等々を開発できるクロスプラットフォームフレームワークであるFlutterを使って開発を行います。</p>
<p>ここでは、下記の理由からFlutter Webを有効にしてWebアプリを開発します。これによって普通のWindowsパソコンでも比較的ストレスなく開発を行うことができます。</p>
<ul>
<li>iPhoneアプリに対応するためにはMacが必要でありWindows PCの人が開発できない</li>
<li>Androidアプリに対応するためにAndroid SDKやAndroid Studioのインストールが必要で準備に時間がかかる</li>
<li>iPhoneアプリとAndroidアプリ開発には十分なスペックのPCが必要でインストールだけでもディスクスペースを大量に消費し開発環境の起動やコンパイルに時間がかかる</li>
<li>Flutter Webを開発すればiPhoneアプリとAndroidアプリにもほぼそのまま転用できる</li>
<li>Flutter Webではファイル保存を担うFirebase Firestorageとデバイスから写真ファイルを簡単に選択できるImagePickerパッケージが対応していないが、コードの追加は簡単にできる</li>
</ul>
<h2 is-upgraded>開発するアプリケーション</h2>
<p>いままで整理してきたユースケースやデータモデルや画面設計のとおり、顧客がレストランのレビューを書き込むアプリケーションを開発します。できあがったFlutter Webアプリのイメージは下記のとおりです。この画面は裏でFirebaseにつながっており実際のWebアプリケーションとして利用できます。顧客としてユーザ登録を行いレストランを参照しレビューを書き込むことができます。</p>
<p>下記サンプルアプリに Email: ichiro@test.com, Password: password でログインしてみてください（おかしな動作をする場合はブラウザのキャッシュをクリアして再度試してください）。</p>
<br><iframe width="400" height="600" src="https://firestore-5643d.web.app" frameborder="1"></iframe>
<p>本書のハンズオンではこのアプリの作り方を学びます。</p>
<aside class="warning"><p><strong>ノート: </strong>上記WebアプリのURLは <a href="https://firestore-5643d.web.app" target="_blank">https://firestore-5643d.web.app</a> です。</p>
<p>スマホのブラウザから開きたい場合は、下記QRコードを読み込んで開いてください。</p>
<p class="image-container"><img style="width: 123.00px" src="img/f5a6c4ab61f6cb9e.png"></p>
</aside>
<h2 is-upgraded>初期設定</h2>
<p>まずはじめに開発に必要なFlutterとエディタであるVS Codeのインストールを行います。</p>
<h3 is-upgraded>Flutterのインストール</h3>
<p>下記リンクから自らの開発PCのOSを選択してFlutter SDKをインストールします。</p>
<p><a href="https://flutter.dev/docs/get-started/install" target="_blank">https://flutter.dev/docs/get-started/install</a></p>
<p>本書ではFlutter Webのみを利用しますので、Andrlid SetupやiOS Setup（Macの場合）の作業は必要ありません。</p>
<h3 is-upgraded>VS Codeのインストール</h3>
<p>下記リンクに従ってVS Codeをインストールします。</p>
<p><a href="https://flutter.dev/docs/get-started/editor?tab=vscode" target="_blank">https://flutter.dev/docs/get-started/editor?tab=vscode</a></p>
<h3 is-upgraded>Chromeのインストール</h3>
<p>開発したWebアプリをデバッグするためにブラウザが必要ですが、Flutterで推奨されているChromeをインストールします。</p>
<p><a href="https://www.google.com/intl/ja_jp/chrome/" target="_blank">https://www.google.com/intl/ja_jp/chrome/</a></p>
<h3 is-upgraded>(Windowsの場合) PowerShellのインストール</h3>
<p>Windows環境の場合ターミナルが使いやすくなるように下記リンクからPowerShellをインストールしておくと良いです。</p>
<p><a href="https://github.com/PowerShell/PowerShell" target="_blank">https://github.com/PowerShell/PowerShell</a></p>
<h3 is-upgraded>インストールの確認</h3>
<p>上記のインストールが完了しているかを確認するため「flutter doctor」コマンドを実行します。下記の通り、FlutterとVS CodeとChromeにチェック「✔︎」が入っていますが、AndroidとXcodeにはインストールがされていないことを表すバツ「✖︎」が表示されます。</p>
<pre>$ flutter doctor
Doctor summary (to see all details, run flutter doctor -v):
[✓] Flutter (Channel beta, 1.20.0, on Mac OS X 10.15.6 19G2021, locale ja-JP)
[✗] Android toolchain - develop for Android devices
    ✗ Unable to locate Android SDK.
      Install Android Studio from: https://developer.android.com/studio/index.html
      On first launch it will assist you in installing the Android SDK components.
      (or visit https://flutter.dev/docs/get-started/install/macos#android-setup for detailed instructions).
      If the Android SDK has been installed to a custom location, set ANDROID_SDK_ROOT to that location.
      You may also want to add it to your PATH environment variable.

[✗] Xcode - develop for iOS and macOS
    ✗ Xcode installation is incomplete; a full installation is necessary for iOS development.
      Download at: https://developer.apple.com/xcode/download/
      Or install Xcode via the App Store.
      Once installed, run:
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
        sudo xcodebuild -runFirstLaunch
    ✗ CocoaPods not installed.
        CocoaPods is used to retrieve the iOS and macOS platform side&#39;s plugin code that responds to your plugin usage on the Dart side.
        Without CocoaPods, plugins will not work on iOS or macOS.
        For more info, see https://flutter.dev/platform-plugins
      To install:
        sudo gem install cocoapods
[✓] Chrome - develop for the web
[!] Android Studio (not installed)
[✓] VS Code (version 1.45.1)
[✓] Connected device (2 available)

! Doctor found issues in 3 categories.</pre>
<h2 is-upgraded>Flutterプロジェクトの作成</h2>
<p>Flutterで開発を始めるにあたってflutterコマンドを使ってFlutter Webプロジェクトの初期フォルダを作成します。</p>
<h3 is-upgraded>Flutter Webの設定</h3>
<p>FlutterによるWebアプリ開発のためには、Flutterコマンド「flutter config --enable-web」を実行してWebアプリ開発を有効化します。</p>
<pre>$ flutter --version
Flutter 1.21.0-10.0.pre.114 • channel master • https://github.com/flutter/flutter.git
Framework • revision b2c0970aa7 (8 hours ago) • 2020-08-16 06:11:02 -0400
Engine • revision b300be3df3
Tools • Dart 2.10.0 (build 2.10.0-34.0.dev)

$ flutter config --enable-web
Setting &#34;enable-web&#34; value to &#34;true&#34;.

You may need to restart any open editors for them to read new settings.</pre>
<h3 is-upgraded>Flutterプロジェクトの作成と実行</h3>
<p>Flutterで開発を始めるには&#34;flutter create [プロジェクト名]&#34;というコマンドを使ってFlutterプロジェクトの初期フォルダを作成します。また、コマンドオプション「--org [パッケージ名]」を追加すると、Dartコードから生成されるiOS用SwiftコードやAndroid用Kotlinコードのパッケージ名を指定できます。パッケージ名はドメイン名を反対にした形式をとるので、例えば弊社ドメイン名&#34;sonrisa.co.jp&#34;にアプリのグループ名&#34;samples&#34;を追加した&#34;samples.sonrisa.co.jp&#34;を反対にした&#34;jp.co.sonrisa.samples&#34;を指定します。このパッケージ名はアプリをAppStoreやGoogle Playに登録する際やFirestoreプロジェクトにアクセスできるアプリを登録する際に使われる重要なものなので、あらかじめルールを決めて指定するように心がけましょう。また、ここでのプロジェクト名は、レストランレビューを登録するアプリであるため「RestoReview」にしてFlutter Webプロジェクトを作成します。</p>
<pre>$ flutter create --org jp.co.sonrisa.samples RestoReview
Creating project RestoReview...
  RestoReview/ios/Runner.xcworkspace/contents.xcworkspacedata (created)
  ...
Running &#34;flutter pub get&#34; in RestoReview...                         2.5s
Wrote 76 files.

All done!
[✓] Flutter: is fully installed. (Channel master, 1.21.0-10.0.pre.114, on Mac OS X 10.15.6 19G2021, locale ja-JP)
[✗] Android toolchain - develop for Android devices: is not installed.
[✗] Xcode - develop for iOS and macOS: is not installed.
[✓] Chrome - develop for the web: is fully installed.
[!] Android Studio: is not available. (not installed)
[✓] VS Code: is fully installed. (version 1.45.1)
[✓] Connected device: is fully installed. (2 available)

Run &#34;flutter doctor&#34; for information about installing additional components.

In order to run your application, type:

  $ cd RestoReview
  $ flutter run

Your application code is in RestoReview/lib/main.dart.</pre>
<p>プロジェクトを作成するとプロジェクト名のフォルダが作成されます。その中身は下記のとおり、プロジェクトの設定を行う&#34;pubspec.yaml&#34;ファイル、Dart言語で書かれたソースコードを置く&#34;lib&#34;フォルダ、プラットフォームごとに自動生成されたソースコードを置く&#34;ios&#34;、&#34;android&#34;、&#34;web&#34;フォルダなどから構成されます。</p>
<pre>RestoReview $ tree .
.
├── pubspec.yaml
├── lib
│   └── main.dart
├── ios
 ...
├── android
 ...
└── web
    ├── favicon.png
    ├── icons
    │   ├── Icon-192.png
    │   └── Icon-512.png
    ├── index.html
    └── manifest.json

50 directories, 80 files</pre>
<p>また、初期状態としてカウンターアプリが生成されますので、それを実行します。</p>
<pre>$ cd RestoReview
$ flutter run -d chrome</pre>
<p>するとChromeブラウザが開き、カウンターアプリが表示されます。</p>
<p class="image-container"><img style="width: 325.22px" src="img/191dee9c0dacdadc.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Dart言語の基礎" duration="0">
        <p>FlutterはDartと呼ばれる新しいプログラミング言語で実装されており、Dart言語を使ってプログラミングを行います。DartはJavaScriptに似た言語で、Webアプリケーションにおいて必要な非同期処理やストリーミング処理にたけたオブジェクト指向言語です。JavaやJavaScriptなどの言語をマスターした読者であればすぐに学習して使えると思います。</p>
<aside class="warning"><p><strong>ノート: </strong>Dart言語の基礎については「<a href="https://codelabs.developers.google.com/codelabs/from-java-to-dart" target="_blank">Intro to Dart for Java Developers</a>」というCodelabを一通りみてください。また「<a href="https://dart.dev/samples" target="_blank">Language samples</a>」もみておくとよいです。Dart言語でのクラスの実装やインタフェース、関数プログラミングについて学べます。</p>
</aside>
<p>ここまでの説明から、アプリケーション開発の基本はデータモデルとアプリ画面のマッピングであることは理解してもらえたかと思います。そのため、アプリ開発においてDart言語が効果的に機能する重要なしくみとしては「1. 認証サービスやデータベースとネットワークごしに非同期でやりとりするデータをうまく処理すること」と「2. 得られたデータ（特にリスト型）を画面表示用にうまく変換すること」といえます。そのため本書では、2のリスト型のデータ変換理解のため「コレクション型」と1の非同期で流れてくるストリームの瞬間をとらえるスナップショット理解のため「非同期処理」を、Dart言語の特徴的で使える機能としてピックアップして解説します。</p>
<aside class="warning"><p><strong>ノート:  </strong>本章ではブラウザ上でDart言語をプログラミングし、実行できるDartpadを使って説明しています。画面が小さくて見にくい場合は、iFrameエリア右上の最大化ボタンをクリックして別タブを開いて試してください。上部のプログラムを実行したい場合は右上のRUNボタンをクリックすると下部のコンソールに実行結果が表示されます。ソースコードが表示されない場合は、ブラウザをリロードしてください。</p>
</aside>
<h2 is-upgraded>Dart言語の文法: コレクション型</h2>
<p>Dartで定義できるコレクション型（同じ型やクラスであるエレメントをまとめてあつかう集合型）には以下の4種類があります。</p>
<ol type="1" start="1">
<li>List型 ... インデックスでエレメントにアクセスするコレクション(例：list[0], list[1],...）</li>
<li>Map型 ... キー・バリュー型のコレクション（例：map[&#34;first&#34;], map[&#34;second&#34;],...）</li>
<li>Set型 ... エレメントの重複を許さないコレクション</li>
<li>Queue型 ... 先入先出し型のコレクション</li>
</ol>
<p>Flutterでのデータモデルとアプリ画面間の変換にはListとMapをよく使うので、それらの使い方と変換方法をステップバイステップで説明します。</p>
<p>1. レストランクラスの作成</p>
<p>ID、名前、タイプ、住所、ロゴ画像URL、星の数といった属性をもつクラスを実装し、そのインスタンスを作成しprint表示します。</p>
<iframe width="850" height="500" src="https://dartpad.dev/embed-inline.html?id=6d1696f7c00719ddaf92b482a5c4396a" frameborder="1"></iframe>
<p>2. JSONからのレストランクラスの作成</p>
<p>&#39;dart:convert&#39;パッケージに含まれる jsonDecodeメソッドを使うと、一つのドキュメントをあらわす「{ }」から始まるJSON文字列からはマップを作成することができるので、このマップからレストランクラスのインスタンスを作成しprint表示します。</p>
<iframe width="850" height="500" src="https://dartpad.dev/embed-inline.html?id=945bed99f9f3c5718972af3d652c2db7" frameborder="1"></iframe>
<p>3. マップからレストランクラスを生成するファクトリ</p>
<p>マップからレストランクラスのインスタンスを作成する部分を、レストランクラスにファクトリ関数「fromMap(String id, Map&lt;String, dynamic&gt; data)」を作成して実装します。</p>
<iframe width="850" height="500" src="https://dartpad.dev/embed-inline.html?id=15c1b361894b2462d4e118b1c96e54a8" frameborder="1"></iframe>
<p>4. JSONからのレストランクラスの配列作成</p>
<p>jsonDecodeメソッドを使うと「[ ]」から始まるJSON文字列からはリストを作成することができるので、このリストからレストランクラスの配列を作成します。JSON文字列をよく見ると「[ ]」の中の配列要素はドキュメントをあらわす「{ }」から成り立つのでマップに変換されます。そのマップを3でつくった「fromMap」関数でレストランクラスに変換して、レストランクラスの配列を生成しています。</p>
<iframe width="850" height="500" src="https://dartpad.dev/embed-inline.html?id=6a0336662fa73c384c4b8d7352e5bca3" frameborder="1"></iframe>
<p>5. リストからレストランクラスの配列作成</p>
<p>JSON文字列から得られたマップのリストを「.map((val)=&gt;function(val)).toList()」という関数を使って、Restoインスタンスのリストに変換します。このしくみはデータベース上のドキュメントデータをマップとして取得するFirestoreの場合でも利用します。変数名や型が不明なマップからRestoクラスに変換することで、画面表示がプログラミングしやすくなります。</p>
<iframe width="850" height="500" src="https://dartpad.dev/embed-inline.html?id=b1f2329101137e1ab19cc77b80df47c6" frameborder="1"></iframe>
<aside class="warning"><p><strong>ノート: </strong>Dart言語のコレクション型については<a href="https://dart.dev/codelabs/iterables" target="_blank">こちら</a>も参照してください。</p>
</aside>
<h2 is-upgraded>Dart言語の文法: 非同期処理</h2>
<p>一般的に、プログラム言語における関数処理においては入力と出力から成り立ちます。関数の引数が入力となり、戻り値が出力となるわけです。ここで例えばネット上の画像データを関数の引数にとり、その画像を画面に表示することを考えます。するとこの関数やその戻り値を画面表示するプログラムは、ネットから画像をダウンロードする時間入力値の到着を待つ必要があります。</p>
<p>また複数人によるグループチャットアプリを想像してみてください。だれかがグループあてにメッセージを打ち込むとします。そのメッセージはデータベースに追加されると同時に送信者以外のグループメンバーにブロードキャストされますが、このようなしくみを実装するにはグループチャット用データベースとチャットアプリがリアルタイムでつながっていて、チャットアプリがデータベース上の変化を検知する必要があります。このしくみを支援するプログラム上のしくみがストリームです。今回はデータベースとしてfirestoreを使うので、firestoreとアプリの常時接続や変化の検知、キャッシュや差分更新といったしくみはfirestoreがアプリ用に提供するSDKを使うことができます。Dart言語の方ではチャット内容を表すチャットクラスの配列を用意し、上記のSDKと連携して変化検知のたびにマップからチャットクラスへのデータ変換を行う必要がありますし、こちらがメッセージを送る際はチャットオブジェクトをマップ変換してデータベースに送信する必要があります。</p>
<p>上記に挙げた処理のことを非同期処理と呼びますが、取得する値が一つの値（ネット上の画像ダウンロードのケース）か、コレクション（グループチャットのケース）かによって、Dartでは扱うクラスが異なります。</p>
<ol type="1" start="1">
<li>Future: 一つの値やオブジェクトを扱う非同期処理用クラス</li>
<li>Stream: コレクションを扱う非同期処理用クラス</li>
</ol>
<p>FutureとStreamの実装例を以下に示します。実際には、FutureもStreamもURLを指定してHTTP経由でデータを取得するクラスやfirestoreのライブラリから取得するので、それらを扱う方法を理解することに集中すれば実装はできるのですが、ここではあえてFutureとStreamのしくみから説明しています。</p>
<p>1. Futureの実装</p>
<p>JSON文字列からレストランオブジェクトを5秒遅れて取得してprint表示するFutureの例です。</p>
<iframe width="850" height="500" src="https://dartpad.dev/embed-inline.html?id=6e70cd1af860045844c79e6adbdec04b" frameborder="1"></iframe>
<p>2. Streamの実装</p>
<p>JSON文字列から取得したマップのリストから1秒おきにレストランオブジェクトを取得してStreamにsinkしてlistenでprint表示するStreamの例です。</p>
<iframe width="850" height="500" src="https://dartpad.dev/embed-inline.html?id=57ffc4b5437bd5e24b58315c9494dea0" frameborder="1"></iframe>
<aside class="warning"><p><strong>ノート: </strong>非同期処理については<a href="https://dart.dev/codelabs/async-await" target="_blank">こちら</a>も参照してください。また詳細については以下の動画が日本語字幕もついており参考になります。</p>
<p>Dartによる非同期処理の動画シリーズ</p>
<p>1. <a href="https://www.youtube.com/watch?v=vl_AaCgudcY" target="_blank">アイソレートとエベントループ</a>: Dart言語がシングルスレッドなのに非同期を実現しているしくみを解説します。</p>
<p>2. <a href="https://www.youtube.com/watch?v=OTS-ap9_aXc" target="_blank">Futureの説明</a>: 一つの値を扱う非同期処理を実現するFutureを解説します。</p>
<p>3. <a href="https://www.youtube.com/watch?v=nQBpOIHE4eE" target="_blank">Streamの説明</a>: 複数の連続した値を扱う非同期処理を実現するStreamを解説します。</p>
<p>4. <a href="https://www.youtube.com/watch?v=SmTCmDMi4BY" target="_blank">Async/Awaitの説明</a>: 関数で複数の非同期処理を順番に実行する場合やFutureやStreamを引数にもつ関数の実装方法を解説します。</p>
<p>5. <a href="https://www.youtube.com/watch?v=TF-TBsgIErY" target="_blank">非同期ジェネレータの説明</a></p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="マテリアルデザイン開発" duration="0">
        <p>Dart言語が理解できたらFlutterを使ってさまざまな画面と画面遷移を実装します。ここではFirebaseを使わず、JSONの静的データから画面と画面遷移のみを実装します。</p>
<p>Flutterの開発を行うには主に画面の部品を構成するWidget（ウィジット）の理解が必要です。「3. 画面設計」でも述べたとおり、画面と画面遷移を構成するにはその裏で状態（ステート）の管理が必要です。例えば、ウィザード遷移を行いアンケートに答える場合には画面間を入力済みのアンケート回答情報をステートに保存し、確認画面表示に利用するとともにデータベースへの送信情報として利用します。FlutterにおけるWidgetにはStatefulWidget（ステートフル・ウィジット）とStatelessWidget（ステートレス・ウィジット）の2種類のWidgetが提供されており、用途によって下記のような使い分けをします。</p>
<p>StatefulWidget ... 一画面の中で状態変化を</p>
<p>StatelessWidget ... 一画面の中で状態変化を</p>
<aside class="warning"><p><strong>ノート: </strong>Widgetの理解のために下記を一読しておいてください。</p>
<p><a href="https://flutter.dev/docs/development/ui/widgets-intro" target="_blank">https://flutter.dev/docs/development/ui/widgets-intro</a></p>
</aside>
<aside class="warning"><p><strong>ノート:  </strong>本章ではブラウザ上でFlutterをプログラミングし実行できるDartpadを使って説明しています。画面が小さくて見にくい場合は、iFrameエリア右上の最大化ボタンをクリックして別タブを開いて試してください。左側のプログラムを実行したい場合は右上のRUNボタンをクリックすると右側の画面にアプリが表示されます。ソースコードが表示されない場合は、ブラウザをリロードしてください。</p>
</aside>
<p>1. シンプルなログイン画面</p>
<p>StatelessWidgetを使ってシンプルなログイン画面を実装します。</p>
<iframe width="900" height="500" src="https://dartpad.dev/embed-flutter.html?id=7d838fc9cf5e52bc860a82166cd90434" frameborder="1"></iframe>
<p>2. ボタンを押すとバリデータを実行するログイン画面</p>
<p>ログインボタンを押すとメールアドレスやパスワードが入力されているか？ルールにのっとって入力されているかをチェックして、条件を満たさない場合エラーメッセージを表示してくれるよう実装します。</p>
<iframe width="900" height="500" src="https://dartpad.dev/embed-flutter.html?id=fcd7a92fb86a50604398c3f8c3b014d2" frameborder="1"></iframe>
<p>3. キー入力でフォーカスが移動しホーム画面に遷移するログイン画面</p>
<p>FocusNodeクラスを使いフィールド値が完了したら次のフィールドにキー操作が移動し、ログインボタンをクリックするとNavigator.pushを使ってホーム画面に遷移するよう実装します。</p>
<iframe width="900" height="500" src="https://dartpad.dev/embed-flutter.html?id=c01622bd27e91e952e62d2f73cc7e131" frameborder="1"></iframe>
<p>4. ログイン/ログアウト状態を管理するランディング画面</p>
<p>ログイン画面とホーム画面をログイン/ログアウト状態を管理するステートを持つランディング画面でつなげるよう実装します。この実装はのちに利用するProviderの簡易実装です。</p>
<iframe width="900" height="500" src="https://dartpad.dev/embed-flutter.html?id=c46188cd4e6fe122914d317c33f8c8a4" frameborder="1"></iframe>
<p>5. 登録画面に切り替えられるログイン画面</p>
<p>ログインボタンと登録ボタンをクリックすることでログイン画面と登録画面を切り替えられるようログイン画面を修正します。一つのWidgetで切り替えを行うにはStatelessWidgetから状態（State）を持つStatefulWidgetに変更が必要なのでLoginクラスにリファクタリングを行います。</p>
<iframe width="900" height="500" src="https://dartpad.dev/embed-flutter.html?id=5376a8be440a38b5fa982d93fea6893d" frameborder="1"></iframe>
<p>6. ホーム画面にボトムナビゲーションバーを追加</p>
<p>ホーム画面にボトムナビゲーションバーを追加して、3画面切り替えられるように実装します。そのために、StatefulWidgetにリファクタリングして、PageViewを使った実装を行います。</p>
<iframe width="900" height="500" src="https://dartpad.dev/embed-flutter.html?id=e38a4cbc44cb0606c86aebe93b301681" frameborder="1"></iframe>
<p>7. ホーム画面の一つであるRestoPageにGridViewを実装</p>
<p>ホーム画面のボトムナビゲーションバーで切り替える画面の一つにJSON文字列から取得したレストランのリストをGridViewで表示する画面を実装します。</p>
<iframe width="900" height="500" src="https://dartpad.dev/embed-flutter.html?id=25c545bff92528e287ccc18290b52462" frameborder="1"></iframe>


      </google-codelab-step>
    
      <google-codelab-step label="Firebaseのセットアップ" duration="0">
        <p>Flutter開発の初期設定が完了したのでインフラ部分を担うFirebaseの設定を行います。</p>
<h2 is-upgraded>1. Firebaseプロジェクトの作成</h2>
<p><a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a>にログインして「プロジェクトを追加」をクリックし、名前を「RestoReview」と命名し、「続行」ボタンをクリック、Google Analyticsの設定後、「プロジェクトを作成」ボタンをクリックしてFirebaseプロジェクトを作成します。</p>
<p class="image-container"><img style="width: 213.20px" src="img/7ec06f011a4782ef.png"></p>
<h2 is-upgraded>2. メール/パスワード認証の有効化</h2>
<p>Firebaseには様々な認証をサポートする機能としてFirebase Authenticationがあります。画面左メニューから「Authentication」を選択し、「Sign-in method」タブを選択します。</p>
<p class="image-container"><img style="width: 402.80px" src="img/c23c9a8dc6acdcc7.png"></p>
<p>「メール/パスワード」を有効化するため、「Authentication」画面のログインプロバイダのリストの最上部「メール/パスワード」行右端の鉛筆アイコンを選択し表示される下記ダイアログで「有効にする」を選択し、保存ボタンをクリックします。</p>
<p class="image-container"><img style="width: 315.60px" src="img/23569565b84e855f.png"></p>
<h2 is-upgraded>3. Firestoreデータベースの有効化</h2>
<p>アプリケーションが利用するデータベースとしてCloud Firestoreを有効化します。</p>
<ol type="1" start="1">
<li>Firebase consoleの画面左メニューから「Database」を選択し、「データベースの作成」ボタンをクリックします。</li>
</ol>
<p class="image-container"><img style="width: 304.40px" src="img/488a58b182df0f17.png"></p>
<ol type="1" start="2">
<li>「本番環境で開始」を選択し「次へ」ボタンをクリックします。これによってセキュリティ・ルールが有効になります。</li>
</ol>
<p class="image-container"><img style="width: 306.00px" src="img/ccbb24d72e3ab3.png"></p>
<ol type="1" start="3">
<li>「Cloud Firestoreのロケーション」で東京を表す「asia-northeast2」を選択して「完了」ボタンをクリックします。ロケーションは好みの場所を選択してもかまいません。</li>
</ol>
<p class="image-container"><img style="width: 379.00px" src="img/cca014cd5b96b98e.png"></p>
<p>以上によりRestoReviewプロジェクトでCloud Firestoreが使えるようになります。</p>
<h2 is-upgraded>Firebase CLIのインストールと設定</h2>
<p>Firebaseのコマンドラインインタフェース(CLI)を使うと、開発したWebアプリや設定ファイルをFirebaseに直接デプロイすることができます。</p>
<aside class="warning"><p><strong>ノート: </strong>Firebase CLIをインストールするには <a href="https://nodejs.org/ja/" target="_blank">NodeJS</a> のインストールが必要です。</p>
</aside>
<ol type="1" start="1">
<li>次のnpmコマンドを実行してFirebase CLIをインストールします。</li>
</ol>
<pre>$ npm -g install firebase-tools</pre>
<ol type="1" start="2">
<li>Firebase CLIが正常にインストールされたか確認します。バージョンは7.4以降である必要があります。</li>
</ol>
<pre>$ firebase --version</pre>
<ol type="1" start="3">
<li>「firebase login」を実行してFirebaseへのログインを試みます。「Allow Firebase to collect CLI usage and error reporting information? (FirebaseがCLIのログ収集することを許可しますか)」と聞かれるので、YかNを入力します。</li>
</ol>
<pre>$ $ firebase login
i  Firebase optionally collects CLI usage and error reporting information to help improve our products. Data is collected in accordance with Google&#39;s privacy policy (https://policies.google.com/privacy) and is not used to identify you.

? Allow Firebase to collect CLI usage and error reporting information? Yes</pre>
<p>ChromeブラウザがオープンしてFirebaseにログインするアカウントの選択を促してくるので、該当アカウントを選択してログインします。</p>
<p class="image-container"><img style="width: 259.58px" src="img/24d656c6bd5e4183.png"></p>
<p>ログインが成功するとFirebase CLIに許可を求められるので「許可」ボタンをクリックして許可すると...</p>
<p class="image-container"><img style="width: 255.60px" src="img/b77a50c9667d67ec.png"></p>
<p>ログインが成功します。</p>
<p class="image-container"><img style="width: 277.89px" src="img/6d39015ea11d142f.png"></p>
<ol type="1" start="4">
<li>「Flutterプロジェクトの作成」で作ったプロジェクトフォルダ（ここでは「RestoReview」）に移動し、「firebase init」を実行し、Firebaseプロジェクトに紐付けます。</li>
</ol>
<pre>$ firebase init</pre>
<ol type="1" start="5">
<li>コマンド実行すると下記画面が表示されるので、Firebase CLIから利用するFirebase機能を選択します。「↑」「↓」キーで機能を選択し、「スペース」キーで「○（非選択）」と「◉（選択）」を切り替えます。ここでは「Firestore」「Functions」「Hosting」「Storage」を選択して「Enter」を押します。</li>
</ol>
<pre>     ######## #### ########  ######## ########     ###     ######  ########
     ##        ##  ##     ## ##       ##     ##  ##   ##  ##       ##
     ######    ##  ########  ######   ########  #########  ######  ######
     ##        ##  ##    ##  ##       ##     ## ##     ##       ## ##
     ##       #### ##     ## ######## ########  ##     ##  ######  ########

You&#39;re about to initialize a Firebase project in this directory:

  /.../RestoReview

? Which Firebase CLI features do you want to set up for this folder? Press Space to select features, then Enter to confirm your choices. ? Which Firebase CLI features do you want to set up for this folder? Press Space to select features, then Enter to confirm your choices. 

 ◯ Database: Deploy Firebase Realtime Database Rules
 ◉ Firestore: Deploy rules and create indexes for Firestore
 ◉ Functions: Configure and deploy Cloud Functions
 ◉ Hosting: Configure and deploy Firebase Hosting sites
❯◉ Storage: Deploy Cloud Storage security rules
 ◯ Emulators: Set up local emulators for Firebase features
</pre>
<ol type="1" start="6">
<li>次にデフォルトのFirebaseプロジェクトの設定を促されるので、「Use an existing project」を選んで「Enter」を押します。</li>
</ol>
<pre>=== Project Setup

First, let&#39;s associate this project directory with a Firebase project.
You can create multiple project aliases by running firebase use --add, 
but for now we&#39;ll just set up a default project.

? Please select an option: 
❯ Use an existing project 
  Create a new project 
  Add Firebase to an existing Google Cloud Platform project 
  Don&#39;t set up a default project </pre>
<ol type="1" start="7">
<li>先ほど作成したFirebaseプロジェクト（ここでは「RestoReview」）を選択して「Enter」を押します。</li>
</ol>
<pre>=== Project Setup

First, let&#39;s associate this project directory with a Firebase project.
You can create multiple project aliases by running firebase use --add, 
but for now we&#39;ll just set up a default project.

? Please select an option: Use an existing project
? Select a default Firebase project for this directory: 
  firestore-xxxxx (firestore) 
❯ restoreview-xxxxx (RestoReview) </pre>
<ol type="1" start="8">
<li>次にセキュリティ・ルールを定義しFirebaseにデプロイするファイル名を指定します。デフォルトのままで「Enter」を押します。</li>
</ol>
<pre>=== Firestore Setup

Firestore Security Rules allow you to define how and when to allow
requests. You can keep these rules in your project directory
and publish them with firebase deploy.

? What file should be used for Firestore Rules? (firestore.rules) </pre>
<ol type="1" start="9">
<li>次にFirestoreのインデックス定義をFirebaseにデプロイするファイル名を指定します。デフォルトのままで「Enter」を押します。</li>
</ol>
<pre>Firestore indexes allow you to perform complex queries while
maintaining performance that scales with the size of the result
set. You can keep index definitions in your project directory
and publish them with firebase deploy.

? What file should be used for Firestore indexes? (firestore.indexes.json) </pre>
<ol type="1" start="10">
<li>次にFunctionsの設定を行います。Functionsで利用するプログラミング言語「TypeScript」を指定し、TSLintを有効にして、生成されるフォルダとファイルを確認して「Enter」を押します。</li>
</ol>
<pre>=== Functions Setup

A functions directory will be created in your project with a Node.js
package pre-configured. Functions can be deployed with firebase deploy.

? What language would you like to use to write Cloud Functions? TypeScript
? Do you want to use TSLint to catch probable bugs and enforce style? Yes
✔  Wrote functions/package.json
✔  Wrote functions/tslint.json
✔  Wrote functions/tsconfig.json
✔  Wrote functions/src/index.ts
✔  Wrote functions/.gitignore
? Do you want to install dependencies with npm now? (Y/n)</pre>
<ol type="1" start="11">
<li>次にHostingの設定を行います。これはFirebaseのホスティング環境にデプロイするFlutter Webの静的コンテンツを指定します。Flutter Webではプロジェクトフォルダ下の「build/web」フォルダにコンパイルされて生成されたWebアプリが配置されるので、そちらを指定します。またindex.htmlファイルをrewriteはNoにして「Enter」を押します。</li>
</ol>
<pre>=== Hosting Setup

Your public directory is the folder (relative to your project directory) that
will contain Hosting assets to be uploaded with firebase deploy. If you
have a build process for your assets, use your build&#39;s output directory.

? What do you want to use as your public directory? build/web
? Configure as a single-page app (rewrite all urls to /index.html)? No
✔  Wrote build/web/404.html
✔  Wrote build/web/index.html</pre>
<ol type="1" start="12">
<li>最後にStorageの設定を行います。セキュリティ・ルールの設定ファイル名をデフォルトのままで「Enter」を押します。これでパソコン上でのFirestoreの初期化が完了です。</li>
</ol>
<pre>=== Storage Setup

Firebase Storage Security Rules allow you to define how and when to allow
uploads and downloads. You can keep these rules in your project directory
and publish them with firebase deploy.

? What file should be used for Storage Rules? storage.rules

i  Writing configuration info to firebase.json...
i  Writing project information to .firebaserc...

✔  Firebase initialization complete!</pre>
<h2 is-upgraded>FlutterプロジェクトのFirebase Hostingへのデプロイ</h2>
<p>Flutterプロジェクト「RestoReview」のカウンターアプリをFirebase Hostingにデプロイします。</p>
<ol type="1" start="1">
<li><a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a>にログインし「RestoReview」プロジェクトを選択します。</li>
<li>アイコン「&lt;/&gt;」をクリックしてWebアプリを追加します。</li>
</ol>
<p class="image-container"><img style="width: 291.50px" src="img/933d2735cf3074a5.png"></p>
<ol type="1" start="3">
<li>アプリのニックネームを「RestoReview」にして「このアプリのFirebase Hostingを設定します」にチェックを入れて「アプリを登録」をクリック</li>
</ol>
<p class="image-container"><img style="width: 291.50px" src="img/7e66fe3f4fb0728b.png"></p>
<ol type="1" start="4">
<li>「Firebase SDKの追加」画面の灰色部分をコピーして、「RestoReview」Flutterプロジェクトの「web/index.html」ファイルの「&lt;meta name=&#34;description&#34; content=&#34;A new Flutter project.&#34;&gt;」と「&lt;!-- iOS meta tags &amp; icons --&gt;」の間に貼り付けます。</li>
</ol>
<p class="image-container"><img style="width: 438.99px" src="img/ecaced4ba2104077.png"></p>
<ol type="1" start="5">
<li>次ページの「Firebase CLIのインストール」はすでに完了しているので「次へ」ボタンをクリックします。</li>
</ol>
<p class="image-container"><img style="width: 444.50px" src="img/a395d49aadd9e73.png"></p>
<ol type="1" start="6">
<li>次のページの「Firebase Hostingへのデプロイ」ではFirebaseへのログインとローカルプロジェクトとFirebaseプロジェクトとの紐付け、Firebase Hostingへのデプロイのコマンドが紹介されていますが、ログインと紐付けはすでに行っており、Hostingへのデプロイは後ほど行うので「コンソールに進む」ボタンをクリックして、FirebaseプロジェクトでのWebアプリの追加を終了します。</li>
</ol>
<p class="image-container"><img style="width: 450.32px" src="img/52506531a99326e5.png"></p>
<ol type="1" start="7">
<li>Flutter Webをビルドします。実は以前Chromeを開いてFlutter Webをデバッグ実行した「flutter run -d chrome」コマンドを実行した際に、Flutter Webのビルドも同時に実行されており、「build/web」フォルダに必要なファイルは生成されていたのですが、Firebase Hostingでの実行に必要な上記4の設定が「index.html」ファイルに追加されたので再度ビルドします。これによってDart言語によって書かれたプログラムがコンパイルされて生成されたJavaScriptとそれを呼び出すindex.htmlが「web/index.html」からコピーされて「build/web」に保存されます。</li>
</ol>
<pre>$ flutter build web</pre>
<ol type="1" start="8">
<li>Flutter Webの静的ファイルをFirebase Hostingにデプロイします。</li>
</ol>
<pre>$ firebase deploy --only hosting

=== Deploying to &#39;restoreview-824b4&#39;...

i  deploying hosting
i  hosting[restoreview-824b4]: beginning deploy...
i  hosting[restoreview-824b4]: found 15 files in build/web
✔  hosting[restoreview-824b4]: file upload complete
i  hosting[restoreview-824b4]: finalizing version...
✔  hosting[restoreview-824b4]: version finalized
i  hosting[restoreview-824b4]: releasing new version...
✔  hosting[restoreview-824b4]: release complete

✔  Deploy complete!

Project Console: https://console.firebase.google.com/project/restoreview-824b4/overview
Hosting URL: https://restoreview-824b4.web.app</pre>
<ol type="1" start="9">
<li>「Hosting URL」として出力されたURLにアクセスするとカウンターアプリが表示されます。</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="Firebase Authを使ったFlutterアプリ開発" duration="0">
        <p>以下のステップでFirebase Authのユーザ/パスワードを使ったユーザ登録・ログイン・ログアウトを実装します。</p>
<p>1. ログイン画面の実装（FormとFirebaseAuthの使い方）</p>
<p>2. LandigPageの実装(FirebaseAuthとStreamBuilderの使い方)</p>
<p>3. ホーム画面の実装（BottomNavigationBarの使い方）</p>
<p>4. Auth Blocの作成</p>
<p>あああ</p>
<h2 is-upgraded>Firebase Authを使ったログイン開発</h2>
<p>あああ</p>


      </google-codelab-step>
    
      <google-codelab-step label="Flutterプロジェクトのリポジトリ管理" duration="0">
        <p>あああ</p>


      </google-codelab-step>
    
      <google-codelab-step label="Firestoreを使ったFlutterアプリ開発" duration="0">
        <p>あああ</p>
<h2 is-upgraded>Flutterアプリ起動時の初期データ登録の開発</h2>
<p>あああ</p>
<h2 is-upgraded>ログインユーザのプロフィール画面の開発</h2>
<p>あああ</p>
<h2 is-upgraded>レストランリスト表示画面の開発</h2>
<p>あああ</p>
<h2 is-upgraded>レストラン詳細画面とレビューリスト画面の開発</h2>
<p>あああ</p>
<h2 is-upgraded>レビュー登録画面と編集画面の開発</h2>
<p>あああ</p>
<h2 is-upgraded>レストラン平均星数登録のトランザクション処理</h2>
<p>あああ</p>


      </google-codelab-step>
    
      <google-codelab-step label="セキュリティルールの作成とデプロイ" duration="0">
        <p>あああ</p>


      </google-codelab-step>
    
      <google-codelab-step label="UnitテストとWidgetテスト" duration="0">
        <p>TODO あああ</p>


      </google-codelab-step>
    
      <google-codelab-step label="AndroidとiOS用ビルド方法" duration="0">
        <p>TODO XcodeインストールとAndroid SDK(コマンドのみ<a href="https://qiita.com/undrthemt/items/1861d5fe39be46a2b776" target="_blank">https://qiita.com/undrthemt/items/1861d5fe39be46a2b776</a>)をインストールしてビルドする方法</p>


      </google-codelab-step>
    
      <google-codelab-step label="スマホアプリのテスター配布" duration="0">
        <p>TODO Firebase App Distributionの方法を解説</p>
<p><a href="https://firebase.google.com/docs/app-distribution/ios/distribute-console?hl=ja" target="_blank">https://firebase.google.com/docs/app-distribution/ios/distribute-console?hl=ja</a> </p>


      </google-codelab-step>
    
      <google-codelab-step label="FlutterおよびFirebaseのセキュリティ" duration="0">
        <p>TODO 本書での構成はフロントのネイティブアプリ開発はFlutterにまかせ、バックエンドもFirebaseにまかせるので、APIやWebアプリの開発は発生せず、それらの脆弱性は考える必要がない。そのため、Flutterで構築するネイティブアプリの脆弱性回避とFirebaseの主要機能であるFirestoreとFirestorageとCloud Functionsで妥当なセキュリティルールの設定をすることに注力するだけでよい。あとは脆弱性診断など第三者によるチェックの仕方を考えることくらい。</p>
<p>参考）Flutterアプリ開発七つの大罪：<a href="https://qiita.com/__naoya__/items/98ac66157a1578be2798" target="_blank">https://qiita.com/__naoya__/items/98ac66157a1578be2798</a></p>
<p>参考）Flutter Security：<a href="https://flutter.dev/security" target="_blank">https://flutter.dev/security</a></p>
<p>参考）How to make a flutter app with high security? ：<a href="https://medium.com/flutter-community/how-to-make-a-flutter-app-with-high-security-880ef0aa54da" target="_blank">https://medium.com/flutter-community/how-to-make-a-flutter-app-with-high-security-880ef0aa54da</a></p>
<p>参考）Mobile App Security：<a href="https://www.linkedin.com/pulse/mobile-app-security-native-vs-flutter-rick-wu" target="_blank">https://www.linkedin.com/pulse/mobile-app-security-native-vs-flutter-rick-wu</a></p>
<p>参考）Storing your secret keys in Flutter：</p>
<p><a href="https://medium.com/@sokrato/storing-your-secret-keys-in-flutter-c0b9af1c0f69" target="_blank">https://medium.com/@sokrato/storing-your-secret-keys-in-flutter-c0b9af1c0f69</a></p>
<p>参考）Do you need to hide your Firebase API keys for Ionic apps?</p>
<p><a href="https://javebratt.com/hide-firebase-api/" target="_blank">https://javebratt.com/hide-firebase-api/</a></p>
<p>参考）多くのモバイルアプリに「バックドアシークレット」、オハイオ州立大などが発表</p>
<p><a href="https://www.atmarkit.co.jp/ait/articles/2004/19/news014.html" target="_blank">https://www.atmarkit.co.jp/ait/articles/2004/19/news014.html</a></p>


      </google-codelab-step>
    
      <google-codelab-step label="Firebaseの運用保守" duration="0">
        <p>TODO Firebase参考：<a href="https://www.youtube.com/watch?v=iWEgpdVSZyg" target="_blank">https://www.youtube.com/watch?v=iWEgpdVSZyg</a></p>


      </google-codelab-step>
    
      <google-codelab-step label="まとめ" duration="0">
        <p>あああ</p>
<p>ノンコーディングについて：</p>
<p><a href="https://qiita.com/yugoes1021/items/debce542cdcca2901117" target="_blank">https://qiita.com/yugoes1021/items/debce542cdcca2901117</a></p>
<p><a href="https://builder.honeycode.aws/auth/signup" target="_blank">https://builder.honeycode.aws/auth/signup</a></p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
